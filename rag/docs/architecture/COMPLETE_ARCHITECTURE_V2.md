# UMIS RAG 완전한 아키텍처 v2.0

**버전:** 2.0 (7가지 개선안 반영)  
**날짜:** 2025-11-02  
**상태:** 설계 완료

---

## 🎯 아키텍처 철학

**핵심 원칙:**

```yaml
1. 품질 우선:
   • 검색 품질 > 저장 효율
   • 일관성 > 복잡도
   • 사용자 경험 > 기술적 완벽성

2. 단순성:
   • YAML 중심 (사용자 친화)
   • Cursor 기반 (코딩 불필요)
   • 점진적 복잡화 (필요 시만)

3. 실용성:
   • 오버엔지니어링 방지
   • 가치 있는 것만 구현
   • 미래 준비 (설계는 지금)

4. 안정성:
   • Fail-Safe 다층 방어
   • Layer 독립성
   • 항상 작동 보장
```

---

## 📊 전체 구조

### 4-Layer + 5개 횡단 관심사

```
┌─────────────────────────────────────────────────────────────┐
│  UMIS RAG Complete Architecture                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Layer 1: Dual-Index Modular RAG                       │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  Canonical Index (업데이트용):                         │ │
│  │    • 정규화 청크 (5,000개)                             │ │
│  │    • Write: 1곳만 (일관성 보장!)                       │ │
│  │                                                         │ │
│  │  Projected Index (검색용):                             │ │
│  │    • Agent별 청크 (30,000개)                           │ │
│  │    • Read: 품질 우수!                                  │ │
│  │                                                         │ │
│  │  Hybrid Projection (자동 변환):                        │ │
│  │    • 90% projection_rules.yaml                         │ │
│  │    • 10% LLM 판단                                      │ │
│  │    • LLM 로그 → 규칙 학습                             │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ↓                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Layer 2: Guardian Meta-RAG                            │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  3-Stage Evaluation:                                    │ │
│  │    Stage 1: Weighted Scoring (빠름, 80%)              │ │
│  │    Stage 2: Cross-Encoder (정밀, 15%)                 │ │
│  │    Stage 3: LLM + RAE (최종, 5%)                      │ │
│  │                                                         │ │
│  │  Simple Cache (5줄):                                   │ │
│  │    • 정확히 동일한 것만 재사용                         │ │
│  │    • RAE Index 대신 (오버엔지니어링 방지)             │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ↓                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Layer 3: Knowledge Graph                              │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  Multi-Dimensional Confidence:                          │ │
│  │    • Similarity: Vector 임베딩 (질적)                 │ │
│  │    • Coverage: 분포 분석 (양적)                       │ │
│  │    • Validation: Yes/No (검증)                        │ │
│  │                                                         │ │
│  │  종합 판단: high / medium / low                        │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ↓                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Layer 4: Memory-Augmented                             │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  QueryMemory + GoalMemory:                              │ │
│  │    • 순환 감지 (3회 반복)                             │ │
│  │    • 목표 정렬 (60% 기준)                             │ │
│  │    • Memory-RAG + LLM Hybrid                           │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ═══════════════════════════════════════════════════════════ │
│                   횡단 관심사 (Cross-Cutting)                │
│  ═══════════════════════════════════════════════════════════ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Schema Registry (중앙 집중)                           │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  schema_registry.yaml:                                  │ │
│  │    • 모든 필드 정의                                    │ │
│  │    • Layer 간 매핑                                     │ │
│  │    • 타입 검증                                         │ │
│  │    • 버전 호환성                                       │ │
│  │                                                         │ │
│  │  Contract Tests:                                        │ │
│  │    • Layer 간 호환성 검증                              │ │
│  │    • 배포 시 자동 실행                                 │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Routing Policy (워크플로우)                           │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  routing_policy.yaml:                                   │ │
│  │    • 워크플로우 정의                                   │ │
│  │    • Layer 호출 순서                                   │ │
│  │    • 조건 실행 (when)                                  │ │
│  │    • 가독성 우수                                       │ │
│  │                                                         │ │
│  │  WorkflowExecutor (~30줄):                             │ │
│  │    • YAML 파싱 및 실행                                 │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Fail-Safe System (안정성)                             │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  Tier 1: Graceful Degradation                          │ │
│  │    • try-except 보호                                   │ │
│  │    • 실패해도 계속                                     │ │
│  │                                                         │ │
│  │  Tier 2: Mode Toggle                                   │ │
│  │    • runtime_config.yaml                               │ │
│  │    • Layer별 on/off                                    │ │
│  │                                                         │ │
│  │  Tier 3: Circuit Breaker                               │ │
│  │    • 3회 실패 → 자동 차단                             │ │
│  │    • 복구 시 재시도                                    │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Overlay Layer (향후, 설계만)                          │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  3-Layer:                                               │ │
│  │    • Core (공식, 검증됨)                               │ │
│  │    • Team (팀 표준)                                    │ │
│  │    • Personal (개인 실험)                              │ │
│  │                                                         │ │
│  │  검색 우선순위: Personal > Team > Core                 │ │
│  │                                                         │ │
│  │  승격 경로: Personal → Team → Core                     │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Learning Loop (자동 개선)                             │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │                                                         │ │
│  │  LLM 판단 로그:                                         │ │
│  │    • Projection 결정 기록                              │ │
│  │    • 패턴 분석 (주간)                                  │ │
│  │    • 자동 규칙 생성                                    │ │
│  │                                                         │ │
│  │  효과:                                                  │ │
│  │    • LLM 10% → 5% → 1%                                 │ │
│  │    • 비용 ↓, 속도 ↑                                   │ │
│  │    • 품질 ↑ (규칙 누적)                               │ │
│  │                                                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 💡 왜 이런 구조인가?

### 1. Dual-Index (Layer 1)

```yaml
문제:
  Pre-Projection: 일관성 위험 (6곳 동기화)
  Lazy Projection: 품질 저하 (노이즈 40%)

해결:
  Dual-Index = 품질 + 일관성
  
  • Canonical: 1곳 수정 (일관성)
  • Projected: 검색 품질 (노이즈 0%)

가치:
  업데이트 안전, 검색 정확
```

### 2. Schema Registry (횡단)

```yaml
문제:
  4-Layer 공통 필드 → 불일치 위험

해결:
  중앙 집중 스키마 관리
  
  • 모든 필드 정의
  • Layer 간 매핑
  • Contract Tests

가치:
  필드 일관성, 버전 안전
```

### 3. Routing YAML (횡단)

```yaml
문제:
  Python 코드 → 가독성 낮음

해결:
  YAML 워크플로우
  
  • 순서 명확
  • 조건 가시적
  • 사용자 수정 쉬움

가치:
  가독성, 유연성
```

### 4. Multi-Dimensional Confidence (Layer 3)

```yaml
문제:
  단일 차원 → 예외 케이스

해결:
  질적 + 양적 + 검증
  
  • Similarity (Vector)
  • Coverage (분포)
  • Validation (Yes/No)

가치:
  예외 없는 평가
```

### 5. Fail-Safe (횡단)

```yaml
문제:
  한 Layer 실패 = 전체 실패

해결:
  3-Tier 방어
  
  • Graceful Degradation
  • Mode Toggle
  • Circuit Breaker

가치:
  항상 작동, 안정성
```

### 6. Overlay Layer (향후)

```yaml
문제:
  개인 실험 vs 팀 표준 충돌

해결:
  Core / Team / Personal
  
  • 격리, 안전
  • 승격 경로

가치:
  협업, 실험 자유
```

### 7. Learning Loop (횡단)

```yaml
문제:
  LLM 판단 → 비용

해결:
  로그 → 규칙 학습
  
  • 10% → 1%
  • 자동 개선

가치:
  비용 ↓, 품질 ↑
```

---

## 🔧 구현 우선순위

```yaml
즉시 (v6.3.0-alpha):
  ✅ Layer 1: Vector RAG (완료!)

Phase 1 (2주):
  🔴 Dual-Index (Layer 1)
  🔴 Schema Registry
  🔴 Routing YAML
  🔴 Fail-Safe Tier 1-2

Phase 2 (2주):
  🔴 Knowledge Graph (Layer 3)
  🔴 Multi-Dimensional Confidence
  🔴 Circuit Breaker

Phase 3 (2주):
  🟡 Guardian Memory (Layer 4)
  🟡 Learning Loop

Phase 4 (향후):
  🟢 Overlay Layer (팀 확장 시)
```

---

## 🎯 핵심 가치

**이 아키텍처가 제공하는 것:**

```yaml
품질:
  ✅ 검색 정확도 (Dual-Index)
  ✅ 평가 신뢰성 (Multi-Dimensional)
  ✅ 일관성 (1곳 수정)

효율:
  ✅ 업데이트 간단 (Canonical)
  ✅ 자동 학습 (LLM → 규칙)
  ✅ 비용 최적화

안정성:
  ✅ 항상 작동 (Fail-Safe)
  ✅ Layer 독립성 (Toggle)
  ✅ 자동 복구 (Circuit)

확장성:
  ✅ 팀 협업 (Overlay)
  ✅ 개인 실험 (Personal)
  ✅ 점진적 (설계 먼저)

사용자:
  ✅ Cursor 중심
  ✅ YAML 수정
  ✅ 대화만!
```

---

**다음:** YAML 스펙 작성

