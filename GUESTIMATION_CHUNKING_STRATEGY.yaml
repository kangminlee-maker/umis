# Guestimation Chunking Strategy
# 학습된 규칙의 청킹 크기 및 전략

meta:
  version: "1.0"
  date: "2025-11-07"
  purpose: "Guestimation 데이터의 청킹 전략 결정"

---

# ═══════════════════════════════════════════════════════
# PART 1: 기존 청킹 구조 (비교 대상)
# ═══════════════════════════════════════════════════════

existing_chunking:
  
  기존_패턴_사례_청크:
    
    단위: "1개 패턴 or 1개 사례 = 1개 Canonical 청크"
    
    예시_구독_모델_패턴:
      
      Canonical:
        chunk_id: "CAN-subscription-001"
        
        content_크기: 500-1,000 tokens
        
        내용:
          - pattern_id: subscription_model
          - trigger_observations: 200 tokens
          - success_cases: 300 tokens
          - implementation_guide: 200 tokens
          - critical_success_factors: 150 tokens
          - risks: 150 tokens
        
        sections:
          - explorer: trigger, success_cases
          - quantifier: metrics, calculations
          - validator: validation_criteria
          - observer: structure_patterns
      
      Projected_청크:
        
        Explorer_View:
          chunk_id: "PRJ-subscription-exp-001"
          
          content_크기: 300-500 tokens
          
          내용:
            - trigger_observations (Explorer 관심)
            - success_cases (Explorer 관심)
          
          metadata:
            agent_view: "explorer"
            explorer_pattern_id: "subscription_model"
        
        Quantifier_View:
          chunk_id: "PRJ-subscription-qnt-001"
          
          content_크기: 200-300 tokens
          
          내용:
            - metrics (Quantifier 관심)
            - calculations (Quantifier 관심)
          
          metadata:
            agent_view: "quantifier"
    
    청킹_비율:
      1개_Canonical → 4-5개_Projected (Agent별)
      
      예:
        CAN-subscription-001 (1개)
        → PRJ-subscription-exp-001 (explorer)
        → PRJ-subscription-qnt-001 (quantifier)
        → PRJ-subscription-val-001 (validator)
        → PRJ-subscription-obs-001 (observer)

---

# ═══════════════════════════════════════════════════════
# PART 2: Guestimation 청킹 옵션
# ═══════════════════════════════════════════════════════

guestimation_chunking_options:
  
  핵심_질문:
    - 1개 학습 규칙 = 몇 개 청크?
    - 청크 크기는?
    - 어떻게 나눌 것인가?
  
  옵션_1_질문당_1청크:
    
    개념: "1개 질문 = 1개 Canonical = 1개 Projected"
    
    예시:
      
      질문: "한국 음식점 월매출은?"
      
      Canonical:
        chunk_id: "CAN-learned-food-001"
        
        content:
          질문: "한국 음식점 월평균 매출은?"
          
          결과:
          - 값: 2,700만원
          - 범위: 1,890 ~ 3,510만원
          
          맥락:
          - 도메인: Food Service
          - 지역: 한국
          - 시점: 2024년
          
          근거:
          - 웹 검색: 3,000만원
          - RAG: 2,500만원
          - LLM: 2,700만원
        
        크기: 200-300 tokens
      
      Projected:
        chunk_id: "PRJ-learned-food-gst-001"
        
        content: (동일)
        
        크기: 200-300 tokens
        
        metadata:
          agent_view: "guestimation"
          guestimation_question: "한국 음식점 월매출은?"
          guestimation_value: 2700만원
          # ...
    
    비율: 1:1 (Canonical 1개 → Projected 1개)
    
    장점:
      ✅ 단순함
      ✅ 1:1 매핑
      ✅ 관리 쉬움
    
    단점:
      ❌ 청크 개수 많음 (질문 1개당 1청크)
      ❌ 유사 질문도 별도 청크
  
  옵션_2_도메인당_1청크:
    
    개념: "같은 도메인의 여러 규칙을 1개 청크로"
    
    예시:
      
      Canonical:
        chunk_id: "CAN-learned-food-bundle-001"
        
        content:
          도메인: Food Service
          
          규칙_1:
            질문: "한국 음식점 월매출은?"
            결과: 2,700만원
          
          규칙_2:
            질문: "한국 카페 월매출은?"
            결과: 3,200만원
          
          규칙_3:
            질문: "한국 식당 고객수는?"
            결과: 80명/일
          
          # ... 10-20개 규칙
        
        크기: 1,000-2,000 tokens
      
      Projected:
        chunk_id: "PRJ-learned-food-gst-001"
        
        content: (동일)
        
        metadata:
          agent_view: "guestimation"
          guestimation_domain: "Food_Service"
          guestimation_metrics: ["monthly_revenue", "customer_count", ...]
    
    비율: 1:1 (하지만 청크 안에 여러 규칙)
    
    장점:
      ✅ 청크 수 적음 (도메인당 1개)
      ✅ 관리 단순
    
    단점:
      ❌ 검색 정확도 ↓ (여러 규칙 섞임)
      ❌ 특정 질문 찾기 어려움
      ❌ 업데이트 복잡 (일부만 수정 어려움)
  
  옵션_3_하이브리드:
    
    개념: "유사 질문 그룹화, 관련 없으면 분리"
    
    규칙:
      
      그룹화_조건:
        IF 질문_유사도 > 0.9:
          → 같은 청크
        
        ELSE:
          → 별도 청크
      
      예시:
        같은_청크:
          - "한국 음식점 월매출은?"
          - "한국 식당 평균 매출은?"
          - "국내 음식점 매출은?"
          → 유사도 >0.9 → 1개 청크
        
        별도_청크:
          - "한국 음식점 월매출은?"
          - "한국 카페 월매출은?"
          → 유사도 0.75 → 별도 청크
    
    장점:
      ✅ 검색 정확도 유지
      ✅ 청크 수 적당히 감소
    
    단점:
      ❌ 그룹화 로직 복잡
      ❌ 유사도 임계값 결정 어려움

---

# ═══════════════════════════════════════════════════════
# PART 3: 청킹 크기 분석
# ═══════════════════════════════════════════════════════

chunk_size_analysis:
  
  기존_청크_vs_Guestimation_청크:
    
    비교:
      
      기존_패턴_청크:
        목적: "풍부한 컨텍스트 제공"
        
        크기: 500-1,000 tokens
        
        내용:
          - 패턴 설명: 200 tokens
          - 트리거: 150 tokens
          - 사례: 300 tokens
          - 가이드: 200 tokens
          - 리스크: 150 tokens
        
        이유:
          - LLM이 패턴 이해 필요
          - 풍부한 맥락 제공
      
      Guestimation_청크:
        목적: "빠른 값 검색"
        
        필요_정보:
          - 질문: 20 tokens
          - 결과: 30 tokens (값, 범위)
          - 맥락: 50 tokens (domain, region, ...)
          - 근거: 100 tokens (출처, 전략)
        
        크기: 200-300 tokens
        
        이유:
          - 값만 필요
          - 컨텍스트 최소
    
    차이:
      기존: 500-1,000 tokens (크고 풍부)
      Guestimation: 200-300 tokens (작고 간결)
      
      비율: 1/3 ~ 1/5
  
  임베딩_크기:
    
    동일:
      모델: text-embedding-3-large
      차원: 3,072 dim
      크기: 12KB/청크
      
      Guestimation도 동일!
    
    총_크기:
      청크_텍스트: 300 tokens × 2 bytes = 600 bytes
      임베딩: 3,072 × 4 bytes = 12KB
      메타데이터: 1-2KB (JSON)
      
      총: ~15KB/청크
      
      2,000개: 30MB (작음!)

---

# ═══════════════════════════════════════════════════════
# PART 4: 권장 청킹 전략
# ═══════════════════════════════════════════════════════

recommended_strategy:
  
  권장: "옵션_1 (질문당 1청크)" ✅
  
  이유:
    
    1_검색_정확도:
      
      질문당_1청크:
        질문: "한국 음식점 월매출은?"
        
        임베딩: 질문 중심
        
        검색:
          유사_질문: "국내 식당 매출은?"
          유사도: 0.88 (높음!)
          매칭: ✅
      
      도메인당_1청크:
        청크_내용: "Food Service 10개 규칙"
        
        임베딩: 혼합 (10개 질문 평균)
        
        검색:
          유사_질문: "국내 식당 매출은?"
          유사도: 0.65 (낮음, 희석됨)
          매칭: 어려움 ❌
    
    2_업데이트_용이성:
      
      질문당_1청크:
        규칙_1개_수정:
          - 해당 청크만 업데이트
          - 다른 청크 영향 없음
      
      도메인당_1청크:
        규칙_1개_수정:
          - 전체 청크 재생성
          - 임베딩 재계산
          - 비효율
    
    3_메타데이터_정확성:
      
      질문당_1청크:
        metadata:
          guestimation_question: "한국 음식점 월매출은?"
          guestimation_value: 2700만원
          guestimation_region: "한국"
        
        필터링: 정확!
      
      도메인당_1청크:
        metadata:
          guestimation_domain: "Food_Service"
          guestimation_questions: ["질문1", "질문2", ...]
        
        필터링: 부정확 (어떤 질문인지 모호)
    
    4_청크_수_허용_가능:
      
      예상:
        Year 1: 2,000개 질문 = 2,000개 청크
        
        크기: 2,000 × 15KB = 30MB
        
        검색_성능: 0.2-0.3초 (filter 사용)
      
      평가:
        크기: 작음 ✅
        성능: 목표 내 ✅
        
        청크_많은_것_문제_없음!
  
  청킹_사양:
    
    단위: "1개 질문 = 1개 Canonical = 1개 Projected"
    
    Canonical_청크:
      
      chunk_id: "CAN-learned-[domain]-[seq]"
      
      예: "CAN-learned-food-001"
      
      chunk_type: "learned_estimation_rule"
      
      content:
        질문: "한국 음식점 월평균 매출은?"
        
        맥락:
        - 의도: 시장 이해
        - 도메인: Food Service
        - 지역: 한국
        - 시점: 2024년
        - 세분화: 전체 평균
        
        추정 결과:
        - 값: 2,700만원
        - 범위: 1,890만원 ~ 3,510만원
        - 단위: 원
        - 불확실성: ±30%
        - 신뢰도: 85%
        
        출처 및 근거:
        - 웹 검색: 3,000만원 (가중치 0.6)
        - RAG 벤치마크: 2,500만원 (가중치 0.8)
        - LLM 직접: 2,700만원 (가중치 0.7)
        
        판단 전략: 가중 평균
        증거 개수: 5개
        
        메타 정보:
        - 출처: Tier 2 학습
        - 생성일: 2024-11-07
        - 사용 횟수: 10회
        - 마지막 검증: 2024-11-07
      
      크기: 200-300 tokens
      
      sections:
        - agent_view: "guestimation"
          anchor_path: "learned_rules.[domain].[metric]"
          content_hash: "sha256:..."
    
    Projected_청크:
      
      chunk_id: "PRJ-learned-food-gst-001"
      
      agent_view: "guestimation"
      
      canonical_chunk_id: "CAN-learned-food-001"
      
      content: (Canonical과 거의 동일)
        질문: "한국 음식점 월평균 매출은?"
        값: 2,700만원
        범위: 1,890 ~ 3,510만원
        맥락: {...}
      
      크기: 200-300 tokens
      
      metadata:
        agent_view: "guestimation"
        
        # 검색 최적화 필드
        guestimation_question: "한국 음식점 월매출은?"
        guestimation_question_normalized: "한국 음식점 월매출"
        guestimation_question_keywords: ["한국", "음식점", "월매출"]
        
        guestimation_metric: "monthly_revenue"
        guestimation_value: 2700만원
        guestimation_value_min: 1890만원
        guestimation_value_max: 3510만원
        guestimation_unit: "원"
        
        # 맥락 필터링용
        guestimation_intent: "understand_market"
        guestimation_domain: "Food_Service"
        guestimation_region: "한국"
        guestimation_time_period: "2024"
        guestimation_granularity: "macro"
        
        # 신뢰도
        guestimation_confidence: 0.85
        guestimation_uncertainty: 0.30
        
        # 출처
        tier_origin: "tier2"
        sources: ["web_search", "rag_benchmark", "llm_direct"]
        
        # 통계
        usage_count: 10
        created_at: "2024-11-07"
        last_verified: "2024-11-07"

---

# ═══════════════════════════════════════════════════════
# PART 5: 청크 증가 시뮬레이션
# ═══════════════════════════════════════════════════════

chunk_growth_simulation:
  
  시나리오:
    
    Week_1:
      학습_규칙: 10개
      
      Canonical:
        기존: 100개
        추가: 10개 (learned_estimation_rule)
        총: 110개
      
      Projected:
        기존: 700개
        추가: 10개 (guestimation)
        총: 710개
    
    Month_1:
      학습_규칙: 100개
      
      Canonical:
        총: 200개 (100 + 100)
      
      Projected:
        총: 800개 (700 + 100)
    
    Month_6:
      학습_규칙: 500개
      
      Canonical:
        총: 600개 (100 + 500)
      
      Projected:
        기존: 700개
        guestimation: 500개
        총: 1,200개
    
    Year_1:
      학습_규칙: 2,000개
      
      Canonical:
        총: 2,100개 (100 + 2,000)
      
      Projected:
        기존: 700개
        guestimation: 2,000개
        총: 2,700개
  
  크기_분석:
    
    Year_1:
      
      canonical_index:
        청크: 2,100개
        크기/청크: 평균 2KB (Guestimation은 작음)
        총: 4.2MB
        임베딩: 2,100 × 12KB = 25MB
        총: ~30MB
      
      projected_index:
        청크: 2,700개
        크기/청크: 평균 2KB
        총: 5.4MB
        임베딩: 2,700 × 12KB = 32MB
        총: ~40MB
      
      전체_증가: ~70MB
      
      평가: 완전히 무시 가능!

---

# ═══════════════════════════════════════════════════════
# PART 6: 기존 패턴과의 관계
# ═══════════════════════════════════════════════════════

relationship_with_patterns:
  
  기존_패턴_활용:
    
    시나리오: "구독 모델 패턴에 추정 데이터 추가"
    
    Canonical_확장:
      
      chunk_id: "CAN-subscription-001"
      chunk_type: "business_model_pattern"
      
      content:
        # 기존 내용
        pattern_id: subscription_model
        trigger_observations: "..."
        success_cases: "..."
        
        # 신규 섹션 ⭐
        estimation_data:
          metrics:
            churn_rate:
              value: 0.06
              range: [0.05, 0.07]
              context: {domain: "B2B_SaaS", region: "Global"}
              confidence: 0.80
              source: "industry_benchmark"
            
            arpu:
              value: 50000
              range: [30000, 80000]
              unit: "원"
              context: {domain: "B2B_SaaS", region: "한국"}
              confidence: 0.75
      
      크기: 기존 800 tokens + 추가 200 tokens = 1,000 tokens
      
      sections:
        - agent_view: "explorer"
          anchor_path: "subscription_model.trigger"
        - agent_view: "quantifier"
          anchor_path: "subscription_model.metrics"
        - agent_view: "guestimation" ⭐
          anchor_path: "subscription_model.estimation_data"
    
    Projected_생성:
      
      기존_Views:
        - PRJ-subscription-exp-001 (explorer)
        - PRJ-subscription-qnt-001 (quantifier)
      
      신규_View:
        - PRJ-subscription-gst-001 (guestimation) ⭐
        
        content:
          패턴: subscription_model
          
          추정 가능 지표:
          - Churn Rate: 6% (5-7%)
          - ARPU: 50,000원 (30,000-80,000)
        
        크기: 150-200 tokens (estimation_data만)
        
        metadata:
          agent_view: "guestimation"
          guestimation_pattern_id: "subscription_model"
          guestimation_metrics: ["churn_rate", "arpu"]
  
  학습_규칙_독립:
    
    Canonical:
      chunk_id: "CAN-learned-food-001"
      chunk_type: "learned_estimation_rule"
      
      크기: 200-300 tokens
      
      sections:
        - agent_view: "guestimation" (단일!)
    
    Projected:
      chunk_id: "PRJ-learned-food-gst-001"
      agent_view: "guestimation"
      
      크기: 200-300 tokens

---

# ═══════════════════════════════════════════════════════
# PART 7: 청킹 전략 최종 결정
# ═══════════════════════════════════════════════════════

final_chunking_strategy:
  
  결정: "1개 질문 = 1개 청크" ✅
  
  세부_사양:
    
    Canonical_청크:
      단위: "1개 학습 규칙"
      
      ID_형식: "CAN-learned-[domain]-[seq]"
      
      크기: 200-300 tokens
      
      내용:
        - 질문 (20 tokens)
        - 맥락 (50 tokens)
        - 결과 (30 tokens)
        - 근거 (100 tokens)
      
      chunk_type: "learned_estimation_rule"
      
      sections: 1개 (guestimation만)
    
    Projected_청크:
      단위: "1개 학습 규칙"
      
      ID_형식: "PRJ-learned-[domain]-gst-[seq]"
      
      크기: 200-300 tokens (Canonical과 유사)
      
      agent_view: "guestimation"
      
      메타데이터: 20-25개 필드 (검색 최적화)
    
    비율: 1:1
      1개_Canonical → 1개_Projected (guestimation)
  
  예상_규모:
    
    Year_1:
      
      학습_규칙: 2,000개
      
      Canonical:
        추가_청크: 2,000개
        크기: 2,000 × 2KB = 4MB
        임베딩: 2,000 × 12KB = 24MB
        총: 28MB
      
      Projected:
        추가_청크: 2,000개
        크기: 2,000 × 2KB = 4MB
        임베딩: 2,000 × 12KB = 24MB
        총: 28MB
      
      전체_증가: 56MB
      
      평가: 무시 가능! ✅

---

# ═══════════════════════════════════════════════════════
# PART 8: 청킹 예시 (완전한)
# ═══════════════════════════════════════════════════════

complete_example:
  
  학습_과정:
    
    1_Tier_2_추정:
      질문: "한국 음식점 월평균 매출은?"
      결과: 2,700만원 ± 30%
      사용: 10회
      
      트리거: "학습 대상!"
    
    2_Canonical_생성:
      
      Collection: "canonical_index"
      
      Document:
        id: "CAN-learned-food-001"
        
        embedding: embed("한국 음식점 월평균 매출은? Food Service 2024년 한국...")
        
        document: |
          학습된 추정 규칙
          
          질문: 한국 음식점 월평균 매출은?
          
          맥락:
          - 의도: 시장 이해
          - 도메인: Food Service (음식점, 식당, 레스토랑)
          - 지역: 한국
          - 시점: 2024년
          - 세분화: 전체 평균 (업종/지역 구분 없음)
          
          추정 결과:
          - 값: 2,700만원
          - 범위: 1,890만원 ~ 3,510만원
          - 단위: 원/월
          - 불확실성: ±30%
          - 신뢰도: 85%
          
          판단 근거:
          - 웹 검색 (5개 소스): 평균 3,000만원 (가중치 0.6)
          - RAG 벤치마크: 2,500만원 (가중치 0.8)
          - LLM 직접 추정: 2,700만원 (가중치 0.7)
          
          판단 전략: 가중 평균
          총 증거: 5개
          
          메타:
          - 출처: Tier 2 학습
          - 생성일: 2024-11-07T10:30:00
          - 사용 횟수: 10회
          - 마지막 검증: 2024-11-07
        
        크기: 약 250 tokens
        
        metadata:
          chunk_id: "CAN-learned-food-001"
          chunk_type: "learned_estimation_rule"
          
          domain: "Food_Service"
          
          guestimation_question: "한국 음식점 월평균 매출은?"
          guestimation_metric: "monthly_revenue"
          guestimation_value: 27000000
          guestimation_domain: "Food_Service"
          guestimation_region: "한국"
          guestimation_time_period: "2024"
          
          tier_origin: "tier2"
          learned_at: "2024-11-07T10:30:00"
          usage_count: 10
          
          sections:
            - agent_view: "guestimation"
              anchor_path: "learned_rules.food_service.monthly_revenue"
              content_hash: "sha256:abc123..."
    
    3_Projected_생성:
      
      Collection: "projected_index"
      
      Document:
        id: "PRJ-learned-food-gst-001"
        
        embedding: (Canonical과 동일하거나 재계산)
        
        document: |
          한국 음식점 월평균 매출: 2,700만원
          
          범위: 1,890만원 ~ 3,510만원
          신뢰도: 85%
          
          맥락:
          - 도메인: Food Service
          - 지역: 한국
          - 시점: 2024년
          
          출처: Tier 2 학습 (10회 사용)
        
        크기: 약 200 tokens (간결)
        
        metadata:
          projected_chunk_id: "PRJ-learned-food-gst-001"
          canonical_chunk_id: "CAN-learned-food-001"
          
          agent_view: "guestimation" ⭐
          
          # 검색 최적화
          guestimation_question: "한국 음식점 월평균 매출은?"
          guestimation_question_normalized: "한국 음식점 월매출"
          guestimation_question_template: "[지역] [업종] [지표]"
          guestimation_question_keywords: ["한국", "음식점", "월매출", "평균", "매출"]
          
          # 값
          guestimation_metric: "monthly_revenue"
          guestimation_value: 27000000
          guestimation_value_min: 18900000
          guestimation_value_max: 35100000
          guestimation_unit: "원"
          guestimation_confidence: 0.85
          
          # 맥락
          guestimation_intent: "understand_market"
          guestimation_domain: "Food_Service"
          guestimation_region: "한국"
          guestimation_time_period: "2024"
          guestimation_granularity: "macro"
          
          # 출처
          tier_origin: "tier2"
          sources: ["web_search", "rag_benchmark", "llm_direct"]
          evidence_count: 5
          judgment_strategy: "weighted_average"
          
          # 통계
          usage_count: 10
          created_at: "2024-11-07T10:30:00"
          last_used: "2024-11-07T15:20:00"
          last_verified: "2024-11-07"
          
          # TTL
          materialization_strategy: "on_demand"
          cache_ttl_hours: 24
          access_count: 10

---

# ═══════════════════════════════════════════════════════
# PART 9: Collection 전체 구조 (최종)
# ═══════════════════════════════════════════════════════

final_collection_structure:
  
  ChromaDB_Collections_13개:
    
    1_canonical_index:
      Collection_이름: "canonical_index"
      
      청크_유형:
        business_model_pattern: 31개
        success_case: 54개
        learned_estimation_rule: 0 → 2,000개 ⭐
        disruption_pattern: 23개
      
      총_청크: 108개 → 2,108개
      
      크기: 15MB → 45MB
    
    2_projected_index:
      Collection_이름: "projected_index"
      
      agent_view_별_청크:
        explorer: 354개
        quantifier: 130개
        validator: 134개
        observer: 80개
        guestimation: 0 → 2,000개 ⭐
      
      총_청크: 698개 → 2,698개
      
      크기: 35MB → 135MB
    
    3_explorer_knowledge_base:
      (변화 없음)
    
    4_calculation_methodologies:
      (변화 없음)
    
    # ... 나머지 변화 없음
    
    총_Collections: 13개 (그대로!)

---

# ═══════════════════════════════════════════════════════
# PART 10: 최종 답변
# ═══════════════════════════════════════════════════════

final_answer:
  
  질문_1: "어떤 collection에 저장?"
    
    답변:
      Canonical: "canonical_index" Collection
      Projected: "projected_index" Collection
      
      둘_다_기존_Collection! ✅
  
  질문_2: "collection 없이 view만 늘어나는 건가?"
    
    답변:
      - View는 개념일 뿐
      - 실제로는 projected_index Collection에 청크 추가
      - agent_view 메타데이터로 구분
      
      정확한_표현:
        "projected_index Collection에 
         agent_view='guestimation'인 청크들 추가"
  
  질문_3: "데이터는 어떻게 저장?"
    
    답변:
      저장_위치:
        파일: data/chroma/projected_index/
        
        구조:
          - embeddings.bin (임베딩 벡터)
          - metadata.db (SQLite, 메타데이터)
          - index/ (벡터 인덱스)
        
        청크:
          모든_agent_view_청크가_함께:
            - explorer 청크들
            - quantifier 청크들
            - guestimation 청크들 ⭐
          
          구분: metadata.agent_view
  
  질문_4: "청킹 크기는?"
    
    답변:
      단위: 1개 질문 = 1개 청크
      
      크기:
        content: 200-300 tokens
        임베딩: 12KB (3,072 dim)
        메타데이터: 1-2KB
        총: ~15KB/청크
      
      비교:
        기존_패턴: 500-1,000 tokens
        Guestimation: 200-300 tokens
        
        1/3 크기 (작음!)

---

# ═══════════════════════════════════════════════════════
# END - 청킹 전략 명확화 완료
# ═══════════════════════════════════════════════════════

