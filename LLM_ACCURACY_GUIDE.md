# LLM ìˆ«ì ì •í™•ë„ ë° í™˜ê° ë°©ì§€ ê°€ì´ë“œ

**ì‘ì„±ì¼**: 2025-11-14  
**ëª©ì **: LLMì´ ì¬ë¬´ì œí‘œ ìˆ«ìë¥¼ ì •í™•íˆ ì½ê³  ìƒìƒí•˜ì§€ ì•Šë„ë¡ ë³´ì¥

---

## ğŸ¯ í•µì‹¬ ì›ì¹™

### **1. ì •í™•í•œ ì…ë ¥ (Accurate Input)**
- í…Œì´ë¸”ì„ ëª…í™•í•˜ê²Œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
- ìˆ«ì í¬ë§· ì¼ê´€ì„± ìœ ì§€
- ì¶©ë¶„í•œ ì»¨í…ìŠ¤íŠ¸ ì œê³µ

### **2. êµ¬ì¡°í™”ëœ ì¶œë ¥ (Structured Output)**
- JSON ìŠ¤í‚¤ë§ˆ ì—„ê²©íˆ ì •ì˜
- í•„ìˆ˜ í•„ë“œ ëª…ì‹œ
- ìˆ«ì íƒ€ì… ëª…ì‹œ

### **3. ê²€ì¦ ë¡œì§ (Validation)**
- LLM ì¶œë ¥ ê²€ì¦
- í•©ê³„ í™•ì¸
- ë²”ìœ„ ì²´í¬

### **4. ì œì•½ ì¡°ê±´ (Constraints)**
- "í…Œì´ë¸”ì— ìˆëŠ” í•­ëª©ë§Œ"
- "ìˆ«ìë¥¼ ì •í™•íˆ ë³µì‚¬"
- "ìƒìƒí•˜ì§€ ë§ ê²ƒ"

---

## ğŸ“Š ë¬¸ì œ ì‚¬ë¡€: SKí•˜ì´ë‹‰ìŠ¤

### **í˜„ì¬ ë¬¸ì œ**

**ì…ë ¥ (654ì)**:
```
ê³¼ëª©	ë‹¹ê¸°
ê¸‰ì—¬	829,260
í‡´ì§ê¸‰ì—¬	35,537
...
(13ê°œ í•­ëª©ë§Œ, ë‚˜ë¨¸ì§€ ëˆ„ë½)
```

**LLM ì¶œë ¥**:
- í•­ëª© ìˆ˜: 12ê°œ (ì •í™•)
- í•˜ì§€ë§Œ ê°ê°€ìƒê°ë¹„, ë¬´í˜•ìì‚°ìƒê°ë¹„ ëˆ„ë½
- ê²°ê³¼: 78,012ì–µ (DART 62,487ì–µ, 24.8% ê³¼ë‹¤)

### **ê·¼ë³¸ ì›ì¸**

1. **ì…ë ¥ ë°ì´í„° ë¶€ì¡±**: í…Œì´ë¸” 654ìë¡œ ë„ˆë¬´ ì‘ìŒ
2. **ê²€ì¦ ë¶€ì¬**: LLM ì¶œë ¥ í•©ê³„ í™•ì¸ ì•ˆ í•¨
3. **ì œì•½ ì¡°ê±´ ë¯¸í¡**: "ì •í™•íˆ ë³µì‚¬" ê°•ì¡° ë¶€ì¡±

---

## âœ… í•´ê²° ë°©ì•ˆ

### **ë°©ì•ˆ 1: ì…ë ¥ ë°ì´í„° ì™„ì „ì„± ë³´ì¥** â­â­â­

**í˜„ì¬**:
```python
def extract_table_as_text(section_text: str, max_chars: int = 15000):
    rows = re.findall(r'<TR[^>]*>(.*?)</TR>', section_text[:max_chars], re.DOTALL)
    # ê²°ê³¼: 654ì (ë¶ˆì¶©ë¶„)
```

**ê°œì„ **:
```python
def extract_table_as_text_complete(section_text: str):
    """
    í…Œì´ë¸” ì „ì²´ë¥¼ ë¹ ì§ì—†ì´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    """
    
    # 1. ëª¨ë“  í–‰ ì¶”ì¶œ (max_chars ì œí•œ ì œê±°)
    rows = re.findall(r'<TR[^>]*>(.*?)</TR>', section_text, re.DOTALL)
    
    table_lines = []
    row_count = 0
    
    for row in rows:
        cells = re.findall(r'<(?:TD|TH|TE)[^>]*>(.*?)</(?:TD|TH|TE)>', row, re.DOTALL)
        
        if len(cells) >= 2:
            # ì²« ì—´ (í•­ëª©ëª…), ë§ˆì§€ë§‰ ì—´ (ë‹¹ê¸° ê¸ˆì•¡)
            item_name = extract_text_from_cell(cells[0])
            amount = extract_text_from_cell(cells[-1])
            
            if item_name and len(item_name) > 1:
                # 2. í–‰ ë²ˆí˜¸ ì¶”ê°€ (ê²€ì¦ìš©)
                table_lines.append(f"{row_count+1}. {item_name}\t{amount}")
                row_count += 1
    
    # 3. ì´ í–‰ ìˆ˜ í¬í•¨ (ê²€ì¦ìš©)
    result = f"ì´ {row_count}ê°œ í–‰:\n" + "\n".join(table_lines)
    
    print(f"   ğŸ“Š í…Œì´ë¸” ì¶”ì¶œ: {row_count}ê°œ í–‰, {len(result)}ì")
    
    return result, row_count
```

**íš¨ê³¼**:
- ëª¨ë“  í•­ëª© í¬í•¨ ë³´ì¥
- í–‰ ìˆ˜ë¡œ ëˆ„ë½ ê²€ì¦ ê°€ëŠ¥

---

### **ë°©ì•ˆ 2: í”„ë¡¬í”„íŠ¸ ì œì•½ ì¡°ê±´ ê°•í™”** â­â­â­

**í˜„ì¬**:
```
**ì„ë¬´**: ì•„ë˜ íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„ ì„¹ì…˜ì„ **êµ¬ì¡°ë¥¼ ë¶„ì„**í•˜ì—¬ **ì‹¤ì œ SG&A í•­ëª©ë§Œ** ì¶”ì¶œí•˜ì„¸ìš”.
```

**ê°œì„ **:
```
**ì„ë¬´**: ì•„ë˜ íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„ ì„¹ì…˜ì„ ë¶„ì„í•˜ì—¬ **ì‹¤ì œ SG&A í•­ëª©ë§Œ** ì¶”ì¶œí•˜ì„¸ìš”.

âš ï¸ **ì¤‘ìš”í•œ ì œì•½ ì¡°ê±´**:

1. **ì •í™•íˆ ë³µì‚¬**: í•­ëª©ëª…ê³¼ ìˆ«ìë¥¼ í…Œì´ë¸”ì—ì„œ **ì •í™•íˆ ê·¸ëŒ€ë¡œ** ë³µì‚¬í•˜ì„¸ìš”
   - ìˆ«ìë¥¼ ì¶”ì •í•˜ê±°ë‚˜ ê³„ì‚°í•˜ì§€ ë§ˆì„¸ìš”
   - í…Œì´ë¸”ì— ìˆëŠ” ìˆ«ìë§Œ ì‚¬ìš©í•˜ì„¸ìš”
   
2. **í…Œì´ë¸”ì— ìˆëŠ” ê²ƒë§Œ**: í…Œì´ë¸”ì— ì—†ëŠ” í•­ëª©ì„ ìƒìƒí•˜ê±°ë‚˜ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”
   - ë³´ì´ëŠ” í•­ëª©ë§Œ ì¶”ì¶œ
   - ì—†ëŠ” í•­ëª© ìƒì„± ê¸ˆì§€
   
3. **ëˆ„ë½ ê¸ˆì§€**: í…Œì´ë¸”ì˜ ëª¨ë“  SG&A í•­ëª©ì„ ë¹ ì§ì—†ì´ í¬í•¨í•˜ì„¸ìš”
   - ì´ {row_count}ê°œ í–‰ì´ ìˆìŠµë‹ˆë‹¤
   - í•©ê³„/ì†Œê³„ ì œì™¸ í›„ ì˜ˆìƒ í•­ëª© ìˆ˜: {row_count - 3}ê°œ ë‚´ì™¸
   
4. **ìˆ«ì í¬ë§·**: 
   - ì½¤ë§ˆ(,) ì œê±°
   - ë°±ë§Œì› ë‹¨ìœ„ ê·¸ëŒ€ë¡œ
   - ì˜ˆ: "829,260" â†’ "829260"
```

**íš¨ê³¼**:
- LLMì´ ìƒìƒí•˜ì§€ ì•ŠìŒ
- ìˆ«ì ì •í™•ë„ í–¥ìƒ
- ëˆ„ë½ ë°©ì§€

---

### **ë°©ì•ˆ 3: Few-shot ì˜ˆì œ ì œê³µ** â­â­

**ì¶”ê°€**:
```
**ì˜ˆì œ** (ì˜¬ë°”ë¥¸ íŒŒì‹±):

ì…ë ¥ í…Œì´ë¸”:
```
1. ê¸‰ì—¬	829,260
2. í‡´ì§ê¸‰ì—¬	35,537
3. ì†Œê³„	864,797
4. ê²½ìƒê°œë°œë¹„	3,173,033
5. í•©ê³„	4,037,830
```

ì¶œë ¥:
{{
    "sga_items": [
        {{"name": "ê¸‰ì—¬", "amount": "829260"}},
        {{"name": "í‡´ì§ê¸‰ì—¬", "amount": "35537"}},
        {{"name": "ê²½ìƒê°œë°œë¹„", "amount": "3173033"}}
    ],
    "excluded_items": [
        {{"name": "ì†Œê³„", "reason": "í•©ê³„ í•­ëª©"}},
        {{"name": "í•©ê³„", "reason": "í•©ê³„ í•­ëª©"}}
    ]
}}

âŒ **ì˜ëª»ëœ ì˜ˆ**:
- ê¸ˆì•¡ ì¶”ì •: "ê¸‰ì—¬" â†’ "850000" (X, í…Œì´ë¸”ì— ì—†ìŒ)
- í•­ëª© ì¶”ê°€: "ê°ê°€ìƒê°ë¹„" â†’ "300000" (X, í…Œì´ë¸”ì— ì—†ìŒ)
- ìˆ«ì ë³€ê²½: "829,260" â†’ "829" (X, ë‹¨ìœ„ í‹€ë¦¼)
```

**íš¨ê³¼**:
- LLMì´ ì •í™•í•œ íŒ¨í„´ í•™ìŠµ
- ì‹¤ìˆ˜ ìœ í˜• ëª…ì‹œ

---

### **ë°©ì•ˆ 4: ì¶œë ¥ ê²€ì¦ ë¡œì§** â­â­â­

**ì¶”ê°€**:
```python
def validate_llm_output(result: Dict, table_text: str, row_count: int, dart_total: float):
    """
    LLM ì¶œë ¥ ê²€ì¦
    
    ì²´í¬:
    1. í•­ëª© ìˆ˜ ì ì •ì„±
    2. í•©ê³„ ë²”ìœ„
    3. ìˆ«ì í¬ë§·
    4. í…Œì´ë¸”ì— ìˆëŠ” í•­ëª©ì¸ì§€
    """
    
    issues = []
    
    # 1. í•­ëª© ìˆ˜ ì²´í¬
    sga_items = result.get('sga_items', [])
    expected_count = row_count - 3  # í•©ê³„/ì†Œê³„ ì œì™¸
    
    if len(sga_items) < expected_count * 0.7:  # 70% ë¯¸ë§Œ
        issues.append(f"í•­ëª© ìˆ˜ ë¶€ì¡±: {len(sga_items)}ê°œ (ì˜ˆìƒ {expected_count}ê°œ)")
    
    # 2. í•©ê³„ ë²”ìœ„ ì²´í¬
    total = sum(float(item['amount']) for item in sga_items) / 100  # ì–µì›
    diff_ratio = abs(total - dart_total) / dart_total
    
    if diff_ratio > 0.30:  # 30% ì´ìƒ ì°¨ì´
        issues.append(f"í•©ê³„ ì˜¤ì°¨ {diff_ratio:.1%} (íŒŒì‹± {total:.0f}ì–µ vs DART {dart_total:.0f}ì–µ)")
    
    # 3. ìˆ«ì í¬ë§· ì²´í¬
    for item in sga_items:
        amount = item['amount']
        if ',' in str(amount):
            issues.append(f"ì½¤ë§ˆ í¬í•¨: {item['name']} = {amount}")
        
        try:
            float(amount)
        except:
            issues.append(f"ìˆ«ì ì•„ë‹˜: {item['name']} = {amount}")
    
    # 4. í…Œì´ë¸”ì— ìˆëŠ” í•­ëª©ì¸ì§€ ì²´í¬
    for item in sga_items:
        name = item['name']
        if name not in table_text:
            issues.append(f"í…Œì´ë¸”ì— ì—†ìŒ: {name} (ìƒìƒ ê°€ëŠ¥ì„±!)")
    
    if issues:
        print(f"\n   âš ï¸ ê²€ì¦ ì´ìŠˆ {len(issues)}ê°œ:")
        for issue in issues:
            print(f"      - {issue}")
        return False, issues
    
    print(f"\n   âœ… ê²€ì¦ í†µê³¼")
    return True, []
```

**íš¨ê³¼**:
- ìë™ í’ˆì§ˆ ê²€ì¦
- ìƒìƒ íƒì§€
- ì¬ì‹œë„ íŠ¸ë¦¬ê±°

---

### **ë°©ì•ˆ 5: ì¬ì‹œë„ ë¡œì§** â­

**ì¶”ê°€**:
```python
def parse_with_llm_structure_safe(section_text: str, company: str, dart_total: float, max_retries: 3):
    """
    ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
    """
    
    for attempt in range(max_retries):
        print(f"\nğŸ¤– LLM íŒŒì‹± ì‹œë„ {attempt + 1}/{max_retries}...")
        
        result = parse_with_llm_structure(section_text, company, dart_total)
        
        # ê²€ì¦
        is_valid, issues = validate_llm_output(
            result['llm_response'], 
            table_text, 
            row_count, 
            dart_total
        )
        
        if is_valid:
            print(f"   âœ… ì„±ê³µ!")
            return result
        
        if attempt < max_retries - 1:
            print(f"   âš ï¸ ì¬ì‹œë„... (ì´ìŠˆ: {len(issues)}ê°œ)")
    
    print(f"   âŒ {max_retries}íšŒ ì‹œë„ ì‹¤íŒ¨")
    return result  # ë§ˆì§€ë§‰ ì‹œë„ ë°˜í™˜
```

**íš¨ê³¼**:
- ì¼ì‹œì  LLM ì‹¤ìˆ˜ ë³µêµ¬
- ì‹ ë¢°ë„ í–¥ìƒ

---

### **ë°©ì•ˆ 6: ìˆ«ì ì§ì ‘ ì¶”ì¶œ (Hybrid)** â­â­

**ê°œì„ **:
```python
def hybrid_parse(section_text: str, company: str, dart_total: float):
    """
    1ë‹¨ê³„: ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ìˆ«ì ì¶”ì¶œ
    2ë‹¨ê³„: LLMìœ¼ë¡œ êµ¬ì¡° ë¶„ì„ (í¬í•¨/ì œì™¸ íŒë‹¨ë§Œ)
    3ë‹¨ê³„: ê·œì¹™ ìˆ«ì + LLM íŒë‹¨ ê²°í•©
    """
    
    # 1ë‹¨ê³„: ê·œì¹™ìœ¼ë¡œ ëª¨ë“  í•­ëª© ì¶”ì¶œ
    all_items = extract_all_items_regex(section_text)  # {name: amount}
    
    # 2ë‹¨ê³„: LLMìœ¼ë¡œ êµ¬ì¡° ë¶„ì„
    prompt = f"""
ë‹¤ìŒ í•­ëª©ë“¤ ì¤‘ **ì‹¤ì œ SG&Aë§Œ** ì„ íƒí•˜ì„¸ìš”:

{list(all_items.keys())}

ì œì™¸ ê¸°ì¤€:
- í•©ê³„, ì†Œê³„, ì´ê³„
- ê°œë°œë¹„ ìì‚°í™” (ë¬´í˜•ìì‚°)
- ì—°êµ¬ê°œë°œë¹„ ì´ì§€ì¶œì•¡ (ì´ì•¡)

í¬í•¨ ê¸°ì¤€:
- ê²½ìƒê°œë°œë¹„ (ë¹„ìš©í™”ëœ R&D, í¬í•¨!)
- ê¸‰ì—¬, ë³µë¦¬í›„ìƒë¹„ ë“± ì¼ë°˜ SG&A

ì‘ë‹µ: {{"include": ["ê¸‰ì—¬", "ê²½ìƒê°œë°œë¹„", ...], "exclude": ["ì†Œê³„", "í•©ê³„", ...]}}
"""
    
    llm_decision = llm.ask(prompt)
    
    # 3ë‹¨ê³„: ê²°í•©
    final_items = {k: v for k, v in all_items.items() if k in llm_decision['include']}
    
    return final_items
```

**íš¨ê³¼**:
- ìˆ«ìëŠ” ê·œì¹™ìœ¼ë¡œ ì •í™•íˆ ì¶”ì¶œ (LLM ì½ê¸° ì‹¤ìˆ˜ ë°©ì§€)
- LLMì€ íŒë‹¨ë§Œ (í™˜ê° ê°€ëŠ¥ì„± ë‚®ìŒ)
- ìµœê³ ì˜ ì •í™•ë„

---

## ğŸ“Š ê¶Œì¥ ì¡°í•©

### **Best Practice (SKí•˜ì´ë‹‰ìŠ¤ ê°™ì€ ë³µì¡í•œ ì¼€ì´ìŠ¤)**

```python
def parse_sga_accurate(section_text, company, dart_total):
    # ë°©ì•ˆ 1: ì™„ì „í•œ í…Œì´ë¸” ì¶”ì¶œ
    table_text, row_count = extract_table_as_text_complete(section_text)
    
    # ë°©ì•ˆ 6: Hybrid (ê·œì¹™ ìˆ«ì + LLM íŒë‹¨)
    all_items = extract_all_items_regex(section_text)  # ì •í™•í•œ ìˆ«ì
    
    # ë°©ì•ˆ 2 + 3: ê°•í™”ëœ í”„ë¡¬í”„íŠ¸ + Few-shot
    llm_decision = llm_analyze_structure(
        items=all_items,
        table_text=table_text,
        row_count=row_count,
        dart_total=dart_total,
        constraints="ì •í™•íˆ ë³µì‚¬, í…Œì´ë¸”ì— ìˆëŠ” ê²ƒë§Œ, ëˆ„ë½ ê¸ˆì§€"
    )
    
    # ë°©ì•ˆ 4: ê²€ì¦
    is_valid, issues = validate_llm_output(...)
    
    # ë°©ì•ˆ 5: ì¬ì‹œë„ (í•„ìš” ì‹œ)
    if not is_valid:
        retry(...)
    
    return final_items
```

---

## ğŸ¯ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### **Phase 1: ì¦‰ì‹œ ì ìš©** (SKí•˜ì´ë‹‰ìŠ¤ ìˆ˜ì •)
1. âœ… ë°©ì•ˆ 1: ì™„ì „í•œ í…Œì´ë¸” ì¶”ì¶œ (max_chars ì œê±°)
2. âœ… ë°©ì•ˆ 2: ì œì•½ ì¡°ê±´ ê°•í™” ("ì •í™•íˆ ë³µì‚¬")
3. âœ… ë°©ì•ˆ 4: ê²€ì¦ ë¡œì§ ì¶”ê°€

### **Phase 2: í’ˆì§ˆ í–¥ìƒ**
4. ë°©ì•ˆ 3: Few-shot ì˜ˆì œ
5. ë°©ì•ˆ 5: ì¬ì‹œë„ ë¡œì§

### **Phase 3: ìµœì í™”**
6. ë°©ì•ˆ 6: Hybrid ì ‘ê·¼ (ê·œì¹™ + LLM)

---

## ğŸ“ˆ ì˜ˆìƒ íš¨ê³¼

| ë°©ì•ˆ | ì •í™•ë„ | í™˜ê° ë°©ì§€ | êµ¬í˜„ ë‚œì´ë„ |
|-----|-------|---------|-----------|
| 1. ì™„ì „í•œ í…Œì´ë¸” | +30% | â­â­â­ | ì‰¬ì›€ |
| 2. ì œì•½ ì¡°ê±´ ê°•í™” | +20% | â­â­â­ | ì‰¬ì›€ |
| 3. Few-shot | +10% | â­â­ | ì‰¬ì›€ |
| 4. ê²€ì¦ ë¡œì§ | +15% | â­â­â­ | ì¤‘ê°„ |
| 5. ì¬ì‹œë„ | +10% | â­ | ì‰¬ì›€ |
| 6. Hybrid | +25% | â­â­â­ | ì–´ë ¤ì›€ |

**ì´ ì˜ˆìƒ ê°œì„ **: +60-80% ì •í™•ë„ í–¥ìƒ

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

**LLM íŒŒì‹± ì „**:
- [ ] í…Œì´ë¸” ì „ì²´ ì¶”ì¶œ í™•ì¸
- [ ] í–‰ ìˆ˜ ì¹´ìš´íŠ¸
- [ ] DART ì´ì•¡ ì œê³µ

**í”„ë¡¬í”„íŠ¸ ì‘ì„± ì‹œ**:
- [ ] "ì •í™•íˆ ë³µì‚¬" ëª…ì‹œ
- [ ] "í…Œì´ë¸”ì— ìˆëŠ” ê²ƒë§Œ" ëª…ì‹œ
- [ ] "ëˆ„ë½ ê¸ˆì§€" ëª…ì‹œ
- [ ] ì˜ˆìƒ í•­ëª© ìˆ˜ ì œê³µ
- [ ] Few-shot ì˜ˆì œ í¬í•¨

**LLM ì‘ë‹µ í›„**:
- [ ] í•­ëª© ìˆ˜ í™•ì¸
- [ ] í•©ê³„ ë²”ìœ„ í™•ì¸
- [ ] ìˆ«ì í¬ë§· í™•ì¸
- [ ] í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- [ ] í•„ìš” ì‹œ ì¬ì‹œë„

---

**ê²°ë¡ **: Hybrid ì ‘ê·¼ (ê·œì¹™ìœ¼ë¡œ ìˆ«ì ì¶”ì¶œ + LLMìœ¼ë¡œ íŒë‹¨)ì´ ìµœì ! ğŸš€

