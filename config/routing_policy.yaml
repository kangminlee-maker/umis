# UMIS RAG Routing Policy
# Workflow 정의 및 Layer 라우팅 정책

# ========================================
# Explorer Workflow
# ========================================

explorer_workflow:
  name: "기회 발굴 워크플로우"
  description: "Observer 관찰 → Explorer 기회 발굴 → Quantifier/Validator 검증"

  steps:
    # Step 1: 패턴 매칭
    - id: pattern_search
      name: "패턴 매칭"
      method: search_patterns
      when: always
      input: triggers
      layers: [vector, graph]  # Vector + Graph 사용
      output: matched_patterns
      required: true

    # Step 2: 사례 검색
    - id: case_search
      name: "유사 사례 검색"
      method: search_cases
      when: "patterns.count > 0"
      input: "patterns[0].id"
      layers: [vector]
      output: success_cases
      required: false

    # Step 3: Estimator 협업 (v7.3.2+ 조건부)
    - id: estimator_collaboration
      name: "값 추정 요청"
      agent: estimator
      when: needs_estimation
      input: estimation_query
      output: estimation_result
      required: false
      note: "기회 크기, 우선순위 판단 시 사용"

    # Step 4: Quantifier 협업 (조건부)
    - id: quantifier_collaboration
      name: "정량 분석 요청"
      agent: quantifier
      when: needs_quantitative
      input: "cases[0].source_id"
      output: market_sizing
      required: false

    # Step 5: 가설 생성
    - id: hypothesis_generation
      name: "기회 가설 생성"
      method: generate_hypothesis
      when: always
      input: [patterns, cases, estimator_data, quantifier_data]
      layers: [vector, memory]  # Memory로 순환 체크
      output: hypothesis
      required: true

# ========================================
# Layer Toggle
# ========================================

layer_toggle:
  vector: true     # Vector RAG
  graph: true      # Knowledge Graph
  memory: true     # Guardian Memory
  meta: false      # Meta-RAG (미구현)

# ========================================
# Retrieval Policy (Intent 기반)
# ========================================

retrieval_policy:
  # Intent별 라우팅

  pattern_matching:
    intent: "패턴 매칭"
    triggers:
      - "패턴 찾아"
      - "유사한 모델"
      - "비즈니스 모델"
    layers:
      primary: vector
      enhancement: graph  # Graph로 조합 추가
    top_k: 5

  case_search:
    intent: "사례 검색"
    triggers:
      - "성공 사례"
      - "예시"
      - "유사 산업"
    layers:
      primary: vector
      enhancement: null
    top_k: 3
    filter:
      chunk_type: success_case

  combination_discovery:
    intent: "조합 발견"
    triggers:
      - "조합"
      - "함께 사용"
      - "시너지"
    layers:
      primary: graph
      fallback: vector
    max_combinations: 10

# ========================================
# Fallback Policy
# ========================================

fallback:
  vector_fail:
    action: yaml_only
    message: "Vector RAG 실패 - YAML 기반으로 폴백"

  graph_fail:
    action: skip
    message: "Graph 실패 - Vector만 사용"

  memory_fail:
    action: skip
    message: "Memory 실패 - Memory 없이 진행"

  all_fail:
    action: yaml_only
    message: "모든 RAG 실패 - YAML 기본값 사용"

# ========================================
# Workflow Execution Policy
# ========================================

execution:
  # 동시 실행
  parallel:
    - [pattern_search, case_search]  # 병렬 가능

  # 순차 실행
  sequential:
    - pattern_search
    - hypothesis_generation

  # 선택적 실행
  optional:
    - estimator_collaboration
    - quantifier_collaboration
    - validator_collaboration

  # 타임아웃
  timeouts:
    pattern_search: 30  # 초
    case_search: 30
    hypothesis_generation: 60

# ========================================
# Condition Definitions
# ========================================

conditions:
  needs_estimation:
    check: "requires_value_estimation == true"
    default: false
    note: "v7.3.2+ Estimator 협업 조건"

  needs_quantitative:
    check: "pattern.type == 'market_sizing_required'"
    default: false

  needs_validation:
    check: "confidence < 0.7"
    default: true

  use_graph:
    check: "layer_toggle.graph == true"
    default: true

# ========================================
# Version
# ========================================

_meta:
  version: "1.1.0"
  created_at: "2025-11-03"
  updated_at: "2025-11-08"
  schema: "routing_policy_v1"
  v7_3_2_updates: "Estimator 협업 추가"

