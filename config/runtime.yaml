# UMIS Runtime Configuration v7.11.0
# Fail-Safe 다층 방어: Mode Toggle

# ========================================
# 실행 모드
# ========================================

mode: rag_full  # yaml_only / hybrid / rag_full

# yaml_only: YAML 기반만 (RAG 비활성)
# hybrid: YAML + Vector RAG (안정적)
# rag_full: YAML + Vector + Graph + Memory + Meta + Estimator (모든 기능, v7.11.0) ⭐

# ========================================
# Layer별 활성화
# ========================================

layers:
  vector: true      # Vector RAG (Explorer, Quantifier, Validator, Observer)
  graph: true       # Knowledge Graph (Hybrid Search, 13 노드, 45 관계)
  memory: true      # Guardian Memory (QueryMemory, GoalMemory)
  meta: true        # Meta-RAG (Guardian) ⭐
  estimator: true   # Estimator 4-Stage Fusion (v7.11.0) ⭐
  validator_search: true  # Validator 확정 데이터 검색 (Stage 1) ⭐

# ========================================
# Fail-Safe 설정
# ========================================

fallback:
  # Vector RAG 실패 시
  vector_fail: yaml_only

  # Graph 실패 시
  graph_fail: skip  # Vector만 사용

  # Memory 실패 시
  memory_fail: skip  # Memory 없이 진행

  # Meta-RAG 실패 시
  meta_fail: skip  # Meta-RAG 없이 진행

  # Estimator 실패 시
  estimator_stage3_fail: fallback  # Stage 3 (Fermi) 실패 시 Fallback (certainty: low)
  estimator_boundary_fail: skip  # Boundary 검증 실패 시 스킵

# ========================================
# Circuit Breaker (Stage 3 Fermi)
# ========================================

circuit_breaker:
  enabled: true

  # 실패 카운트
  failure_threshold: 3

  # 타임아웃
  timeout_seconds: 30

  # 복구 시간 (초)
  recovery_timeout: 60

  # 자동 재시도
  auto_retry: true
  max_retries: 2

# ========================================
# 성능 설정
# ========================================

performance:
  # 캐시
  cache_enabled: true
  cache_ttl_hours: 24

  # 동시성
  max_concurrent_requests: 5

  # 로깅
  detailed_logging: true

# ========================================
# 개발/프로덕션 모드
# ========================================

environment: development  # development / production

development:
  verbose_errors: true
  enable_profiling: true
  mock_llm: false

production:
  verbose_errors: false
  enable_profiling: false
  strict_validation: true

# ========================================
# v7.11.0 핵심 기능
# ========================================

v7_11_0_features:

  estimator_4stage_fusion:
    enabled: true
    
    stage_coverage:
      stage_1: "85% (Evidence Collection: Literal, RAG, Validator, Guardrails)"
      stage_2: "10% (Generative Prior: LLM 직접 값 요청)"
      stage_3: "3% (Structural Explanation: Fermi 분해, 재귀 제거)"
      stage_4: "100% (Fusion: 가중 합성, 항상 실행)"
    
    total_coverage: "100%"
    
    key_changes:
      - "5-Phase → 4-Stage Fusion 전환"
      - "재귀 제거 (max_depth=2, Budget 기반)"
      - "LLM Complete Abstraction"
      - "EstimatorRAG → LLMProvider 의존성 주입"
      - "certainty 표준화 (high/medium/low)"
    
    accuracy:
      validator: "100% (0% 오차)"
      stage_3: "80% (25% → 20% 오차, 재귀 제거)"
      e2e_success: "98%"
    
    validator_features:
      - "data_sources_registry (24개)"
      - "단위 자동 변환"
      - "Relevance 검증"
      - "search_definite_data() 메서드"
    
    stage_3_features:
      - "Fallback 체계 (certainty: low)"
      - "Boundary 검증"
      - "개념 타입 일반화 (count, rate, size)"
      - "Budget 기반 탐색 (max_depth=2)"
      - "Step 1-4 (스캔→생성→체크→실행)"

  llm_abstraction:
    enabled: true
    status: "✅ 구현 완료"
    components:
      - "LLMProvider (Interface)"
      - "CursorLLMProvider (Native Mode)"
      - "ExternalLLMProvider (External Mode)"
      - "LLMProviderFactory (Singleton)"
      - "TaskType Enum (Stage별 매핑)"
    benefits:
      - "llm_mode 브랜치 61개 제거"
      - "Clean Architecture (SOLID 원칙)"
      - "확장성 (새 LLM 추가 용이)"

  web_search:
    enabled: true
    default_engine: "duckduckgo"
    engines:
      - "duckduckgo (무료, 기본)"
      - "google (유료, 선택)"
    features:
      - "동적 엔진 선택 (.env)"
      - "Consensus 알고리즘"
      - "숫자 자동 추출"

  meta_rag:
    enabled: true
    status: "✅ 구현 완료"
    components:
      - "QueryMemory (순환 감지)"
      - "GoalMemory (목표 정렬)"
      - "RAEMemory (평가 일관성)"
      - "3-Stage Evaluation (품질 평가)"

# ========================================
# 버전
# ========================================

version: "1.3.0"
updated_at: "2025-11-26"
umis_version: "7.11.0"

# ========================================
# v8: Estimator Fusion Policy (단일 참조 루트)
# ========================================

estimator:
  fusion:
    mode: full  # full | selector_only | disabled
    policy:
      invariants:
        evidence_priority_order:
          - level_1_official
          - level_1b_curated
          - level_2_validated
          - level_3_calculated
          - level_4_prior
        obey_hard_bounds: true
        early_return_enabled: true
      thresholds:
        high_certainty: 0.8
        consistency_tolerance: 0.3  # 허용 가능한 분산/편차
    weights:
      evidence: 0.6        # official/curated/validated 가중
      calculated: 0.3      # calculator convergence 결과
      prior: 0.1           # estimator generative prior

