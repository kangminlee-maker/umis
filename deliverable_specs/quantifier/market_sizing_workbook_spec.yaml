# ========================================
# Market Sizing Workbook Specification
# ========================================
#
# Agent: Bill (Quantifier)
# Output: market_sizing_[name].xlsx (9 sheets)
# Format: Excel with formulas
# Purpose: SAM 계산의 완전한 재현 가능성 보장
#
# ========================================

spec_meta:
  spec_version: "1.1"
  agent_id: "quantifier"
  agent_role: "Quantifier"
  agent_name: "Bill"
  output_format: "xlsx"
  deliverable_type: "market_sizing_workbook"
  created: "2025-11-08"
  updated: "2025-11-26"
  version: "7.11.0"

output_file:
  naming_convention: "market_sizing_{market_name}.xlsx"
  location: "02_analysis/quantifier/market_sizing/"
  total_sheets: 9
  backup_required: "PDF (함수 없이도 검증 가능)"

# ========================================
# Sheet Specifications
# ========================================

sheets:

  sheet_1_assumptions:
    name: "Assumptions"
    order: 1
    purpose: "모든 가정과 전제 조건 명시"

    columns:
      - name: "ID"
        type: "text"
        format: "ASM_001, ASM_002, ..."
        auto_increment: true

      - name: "Category"
        type: "enum"
        values: ["인구", "가격", "빈도", "비율", "기타"]

      - name: "Description"
        type: "text"
        max_length: 100

      - name: "Value"
        type: "number"
        format: "천단위 쉼표"

      - name: "Unit"
        type: "text"
        examples: ["명", "개", "원", "%", "회"]

      - name: "Data_Type"
        type: "enum"
        values: ["직접데이터", "추정치"]
        critical: true
        color_coding:
          직접데이터: "#FFF9C4"  # 노란색
          추정치: "#BBDEFB"      # 파란색

      - name: "Source"
        type: "string"
        format: "SRC_YYYYMMDD_NNN or EST_NNN"
        validation: "반드시 존재하는 SRC_ID 또는 EST_ID"
        cell_comment_required: true

      - name: "Confidence"
        type: "enum"
        values: ["High", "Medium", "Low"]

      - name: "Notes"
        type: "text"
        description: "간단 설명, 상세는 Source 참조"

    formatting:
      header_row:
        background: "#757575"
        font_color: "white"
        bold: true

      data_rows:
        conditional_formatting:
          - condition: "Data_Type = '직접데이터'"
            background: "#FFF9C4"
          - condition: "Data_Type = '추정치'"
            background: "#BBDEFB"

    cell_protection:
      locked: ["ID"]  # auto-increment
      unlocked: ["all others"]

  sheet_2_estimation_details:
    name: "Estimation_Details"
    order: 2
    purpose: "추정치의 7개 섹션 투명 문서화 ⭐"
    critical: true
    note: "재검증 가능성의 핵심 시트!"

    structure:
      format: "EST_NNN 블록별 상세 문서화"
      block_template: "7개 섹션"

    columns:
      - name: "EST_ID"
        type: "text"
        format: "EST_001, EST_002, ..."

      - name: "Item"
        type: "text"
        description: "추정 항목"

      - name: "Final_Value"
        type: "string"
        description: "최종 추정값"

      - name: "Used_In"
        type: "string"
        description: "사용 위치 (ASM_NNN)"

      - name: "Confidence"
        type: "enum"
        values: ["High", "Medium", "Low"]

      - name: "Error_Range"
        type: "string"
        example: "±10%p"

    detailed_documentation:
      location: "각 행 우측 또는 하단 영역"

      seven_sections:

        section_1_reason:
          heading: "[1] 추정 필요 이유"
          required_content:
            - "왜 직접 데이터가 없는가"
            - "어떤 대안을 시도했는가"

        section_2_data_used:
          heading: "[2] 사용한 데이터"
          format: "리스트"
          item_format: "데이터 X: {값} ← SRC_YYYYMMDD_NNN"
          validation: "모든 SRC_ID는 source_registry에 존재"

        section_3_logic:
          heading: "[3] 추정 논리 (단계별)"
          format: "Step 1-N 구조"
          requirements:
            - "각 단계마다 계산 명시"
            - "보정 계수의 근거 설명"
            - "최종 값 도출 과정"

        section_4_reliability:
          heading: "[4] 신뢰도 평가"
          required_items:
            - confidence: "High/Medium/Low"
            - error_range: "±X%"
            - sensitivity: "SAM에 미치는 영향 %"
            - risk: "리스크 평가"

        section_5_verification:
          heading: "[5] 검증 방법"
          required_tests:
            - upper_bound: "상한 테스트"
            - lower_bound: "하한 테스트"
            - benchmark: "벤치마크 비교"

        section_6_alternatives:
          heading: "[6] 대체 접근법 시도"
          format: "시도 N: {방법} → {결과} → {사유}"
          purpose: "왜 현재 추정이 최선인지 증명"

        section_7_usage:
          heading: "[7] 사용 위치"
          content:
            - "Assumptions 시트: ASM_NNN"
            - "Method 시트: 어디에 사용"
            - "영향 범위: 상세"

  sheet_3_method_1_topdown:
    name: "Method_1_TopDown"
    order: 3
    purpose: "TAM → SAM 하향식 계산"
    flexibility: "2-5단계 narrowing 지원"

    column_structure:
      flexible: true
      description: "시장 특성에 따라 컬럼 수 조정"

      minimum_columns: 3  # TAM, Narrowing 1, SAM
      maximum_columns: 7  # TAM, Narrowing 1-5, SAM

      each_column:
        row_1: "단계 명칭 (예: 지역 축소)"
        row_2: "축소 비율 (=Assumptions!B10)"
        row_3: "계산 결과 (=이전*비율)"
        row_4: "출처 (셀 코멘트)"

    validation_area:
      location: "시트 하단 (Row 10 이하)"
      required_checks:
        - test: "논리적 상한"
          formula: "=IF(SAM < TAM, '✅', '❌')"
        - test: "논리적 하한"
          formula: "=IF(SAM > {known_minimum}, '✅', '❌')"
        - test: "비율 합리성"
          formula: "=IF(AND(all_ratios_0_to_100%), '✅', '❌')"
        - test: "최종 타당성"
          formula: "=IF(AND(상한, 하한, 비율), '✅ 통과', '❌ 재검토')"

  sheet_4_method_2_bottomup:
    name: "Method_2_BottomUp"
    order: 4
    purpose: "구성 요소 적산 계산"

    structure:
      format: "세그먼트별 행"
      formula: "수량 × 빈도 × 단가 × 기간"
      total: "SUM(세그먼트들)"

    universal_formulas:
      b2c: "=고객수 * 구매빈도 * 객단가 * 12"
      b2b: "=기업수 * 도입률 * 라이선스비 * 갱신율"
      platform: "=거래건수 * 평균거래액 * 수수료율"

    cross_reference: "모든 입력값은 Assumptions 시트 참조"

  sheet_5_method_3_proxy:
    name: "Method_3_Proxy"
    order: 5
    purpose: "유사 시장 비교 검증"

    structure:
      benchmark_selection: "유사 시장 선택"
      adjustment_factors: ["경제 규모", "문화적 차이", "인프라 차이"]
      final_estimate: "벤치마크 × 조정계수들"

  sheet_6_method_4_competitor:
    name: "Method_4_CompetitorRevenue"
    order: 6
    purpose: "경쟁사 매출 기반 역산"

    columns:
      - "기업명"
      - "전체 매출"
      - "출처 (공시/IR 페이지)"
      - "경쟁영역 비중 (%)"
      - "추정 논리"  # EST_NNN 또는 직접 기재
      - "경쟁 매출 (=전체*비중)"

    calculation:
      step_1: "Top N 경쟁 매출 합계"
      step_2: "시장 점유율 추정"
      step_3: "역산 SAM = 합계 / 점유율"

    traceability_critical:
      - "비중 추정시 반드시 논리 기재"
      - "사업보고서 페이지 번호 명시"
      - "EST_NNN 참조 시 Estimation_Details에 상세"

  sheet_7_convergence:
    name: "Convergence_Analysis"
    order: 7
    purpose: "4가지 방법 수렴 분석 ⭐"
    critical: true

    table_structure:
      rows:
        - "Method 1: Top-Down"
        - "Method 2: Bottom-Up"
        - "Method 3: Proxy"
        - "Method 4: Competitor"
        - "평균"
        - "표준편차"
        - "변동계수 (CV%)"

      columns:
        - "Result": "=Method_N!result_cell"
        - "차이 (vs 평균)": "=B2-$B$7"
        - "차이%": "=C2/$B$7"

    formulas:
      average: "=AVERAGE(B2:B5)"
      stdev: "=STDEV(B2:B5)"
      cv: "=B8/B7"

    convergence_test:
      max_min_ratio: "=MAX(B2:B5)/MIN(B2:B5)"
      pass_30: "=IF(ratio<=1.3, '✅ 통과', '⚠️')"
      pass_50: "=IF(ratio<=1.5, '✅ 수용', '❌')"

    final_sam_selection:
      method: "중간값 or 가중평균"
      formula: "=MEDIAN(B2:B5)"
      confidence_interval: "±15% or ±30%"

  sheet_8_scenarios:
    name: "Scenarios"
    order: 8
    purpose: "Best/Base/Worst Case 시나리오"

    structure:
      variables_table:
        columns: ["변수", "Worst", "Base", "Best", "근거"]
        variables: "핵심 가정들"

      sam_calculation:
        formula: "각 시나리오별 SAM 재계산"

      sensitivity_analysis:
        output: "변수별 SAM 영향도 순위"

  sheet_9_validation:
    name: "Validation_Log"
    order: 9
    purpose: "검증 이력 기록"

    table_structure:
      columns: ["검증자 ID", "검증자명", "검증일", "항목", "결과", "의견"]
      rows:
        - {validator_id: "validator", name: "Rachel", item: "데이터 정의"}
        - {validator_id: "validator", name: "Rachel", item: "신뢰도"}
        - {validator_id: "observer", name: "Albert", item: "구조 부합성"}
        - {validator_id: "observer", name: "Albert", item: "논리 타당성"}
        - {validator_id: "guardian", name: "Stewart", item: "최종 승인"}

# ========================================
# Global Excel Settings
# ========================================

excel_settings:

  color_coding:
    input_direct: "#FFF9C4"     # 노란색 (직접데이터)
    input_estimated: "#BBDEFB"  # 파란색 (추정치)
    calculation: "#FFFFFF"      # 흰색
    result: "#C8E6C9"          # 녹색
    warning: "#FFCDD2"         # 빨간색
    header: "#757575"          # 회색 + 흰색 글자

  cell_comments:
    required_for:
      - "모든 입력 셀: 출처 (SRC_ID or EST_ID)"
      - "모든 가정 셀: 근거 논리"
      - "복잡한 계산 셀: 공식 설명"

  cell_protection:
    locked: ["계산 셀", "결과 셀"]
    unlocked: ["입력 셀"]
    password: null  # 협업 용이

  formula_rules:
    no_hardcoding: "모든 숫자는 Assumptions 참조"
    absolute_reference: "=Assumptions!$D$5"
    named_ranges: "권장 (가독성)"

# ========================================
# Validation Rules
# ========================================

validation_rules:

  structure_completeness:
    - all_9_sheets_exist: true
    - sheet_names_exact: true
    - sheet_order_correct: true

  estimation_details_check:
    - all_est_ids_documented: "Assumptions의 모든 EST_ID가 Estimation_Details에 존재"
    - seven_sections_complete: "각 EST_NNN마다 7개 섹션 작성"
    - all_src_ids_valid: "사용한 모든 SRC_ID가 validator.source_registry에 존재"

  formula_check:
    - no_hardcoded_values: "계산 셀에 직접 숫자 입력 금지"
    - all_calculations_use_formulas: "95% 이상 함수 (상수 제외)"
    - no_circular_references: true

  convergence_check:
    - four_methods_applied: true
    - convergence_within_30: "권장"
    - convergence_within_50: "최소"
    - convergence_analysis_complete: true

  backup_check:
    - pdf_exported: true
    - pdf_filename_correct: "market_sizing_{name}_YYYYMMDD.pdf"
    - all_sheets_in_pdf: true

# ========================================
# AI Generation Workflow
# ========================================

ai_workflow:

  creation:
    step_1: "Quantifier가 SAM 계산 필요 인식"
    step_2: "이 spec 로드"
    step_3: "Excel 파일 생성 (9개 시트)"
    step_4: "Assumptions 시트 작성"
    step_5: "Estimation_Details 추정 논리 문서화"
    step_6: "Method 1-4 계산 (함수로)"
    step_7: "Convergence 분석"
    step_8: "Scenarios, Validation 시트 작성"
    step_9: "PDF 백업 생성"
    step_10: "[DELIVERABLE_COMPLETE] quantifier {filename}.xlsx"

  integration:
    with_validator:
      - "Assumptions Source 컬럼에 SRC_ID 참조"
      - "Estimation_Details [2]에서 SRC_ID 사용"
      - "검증 요청: 데이터 정의 확인"

    with_observer:
      - "시장 구조 분석 결과 참조"
      - "검증 요청: 구조 부합성 확인"

# ========================================
# Example Values
# ========================================

example_data:
  assumptions_row_direct: |
    ASM_001 | 인구 | 전체 음악학원 수 | 10,000 | 개 | 직접데이터 | SRC_20241031_001 | High | 교육부 통계

  assumptions_row_estimated: |
    ASM_002 | 비율 | 피아노 학원 비중 | 30 | % | 추정치 | EST_001 | Medium | 상세: EST_001

  estimation_details_block: |
    EST_001 | 피아노 학원 비중 | 30% | ASM_002 | Medium | ±10%p

    [상세 문서화 영역]
    ============================================
    EST_ID: EST_001
    추정 항목: 피아노 학원 비중
    최종 추정값: 30%
    ============================================

    [1] 추정 필요 이유
    - 교육부 통계에 세부 구분 없음

    [2] 사용한 데이터
    - 전체 음악학원 10,000개 ← SRC_20241031_001
    - 서울 샘플 35% ← SRC_20241031_002
    - 검색량 40:30 ← SRC_20241031_003

    [3] 추정 논리
    Step 1: 35% × 0.85 = 29.75%
    Step 2: 검색량 40% 교차검증
    Step 3: 보수적 30% 적용

    [4] 신뢰도: Medium, ±10%p, SAM 영향 30%
    [5] 검증: 상한 <50%, 하한 >15%, 벤치마크 28%
    [6] 대안: 협회 문의 실패, 전수조사 제약
    [7] 사용: ASM_002, Method_2 계산

