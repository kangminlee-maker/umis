# Guestimation 전체 작업 순서도

**버전**: v2.1 (Fermi Model Search - Pure Recursive)  
**작성일**: 2025-11-05  
**기반**: `config/fermi_model_search.yaml`

**현재 구현**: Unknown → 즉시 재귀 호출  
**향후 구현**: Multi-Layer 우선 시도 후 재귀 (주석 처리됨)

---

## 🎯 전체 흐름 (High-Level)

```
┌─────────────────────────────────────────────────────────────┐
│  Input: Question + Project Context                          │
│  예: "음식점 마케팅 SaaS 시장 규모는?"                        │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: 초기 스캔 (가용 데이터 파악)                       │
│  ├─ Project Context                                         │
│  ├─ Quick LLM 질문 (간단한 사실)                            │
│  └─ 명백한 출처 식별                                         │
│                                                             │
│  Output: available_data[], unknown_data[]                   │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: 모형 생성 (LLM)                                    │
│  ├─ 3-5개 후보 모형 생성                                     │
│  ├─ 다양한 분해 방식                                         │
│  └─ 변수 2-6개 (6개 초과 금지)                               │
│                                                             │
│  Output: candidate_models[3-5개]                            │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: 실행 가능성 체크 (퍼즐 맞추기!)                     │
│  For each model:                                            │
│    ├─ 각 변수 채울 수 있는가?                                │
│    │   ├─ Available? → 사용                                 │
│    │   └─ Unknown? → 즉시 재귀 호출 (depth < 4)             │
│    │                                                         │
│    │   # 향후 구현 (현재 주석):                              │
│    │   # Unknown? → Multi-Layer 시도 (Layer 1-8)             │
│    │   #   ├─ 단일 값 발견? → 사용                           │
│    │   #   └─ 실패? → 재귀 호출                              │
│    │                                                         │
│    ├─ 모든 변수 채움? → feasible ✅                          │
│    └─ 일부 실패? → 대체 변수 탐색 → 재시도                   │
│                                                             │
│  Output: ranked_models[] (점수순)                            │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 4: 최선 모형 실행 (재조립)                            │
│  ├─ 선택: 최고 점수 모형                                     │
│  ├─ 계산: formula(values)                                   │
│  ├─ Backtrack: 재귀 결과 조합                               │
│  └─ Confidence: 각 변수 confidence 조합                     │
│                                                             │
│  Output: FermiResult (value + model + trace)                │
└─────────────────────────────────────────────────────────────┘
```

---

## 📐 Phase 1: 초기 스캔 (상세)

```
Input: "음식점 마케팅 SaaS 시장은?"
  │
  ▼
┌──────────────────────────────────────────┐
│ Step 1: Project Context 확인             │
│ project_context = {                      │
│   '음식점_수': 700000,                   │
│   '서울_인구': 9500000                   │
│ }                                        │
│                                          │
│ 발견:                                    │
│ ✅ 음식점 수: 70만                       │
│ ❌ 시장 규모: 없음                       │
│ ❌ ARPU: 없음                            │
└──────────────────────────────────────────┘
  │
  ▼
┌──────────────────────────────────────────┐
│ Step 2: Quick LLM 스캔                   │
│ 간단한 사실 질문들:                      │
│ - "한국 음식점 수는?"                    │
│ - "일반적인 월 구독료는?"                │
│                                          │
│ 기준: 5초 이내 답변 가능                 │
│                                          │
│ 발견:                                    │
│ ✅ 일반 구독료: 5-10만원 (참고)          │
└──────────────────────────────────────────┘
  │
  ▼
┌──────────────────────────────────────────┐
│ Step 3: 명백한 출처 식별                 │
│ 확실히 구할 수 있는 것:                  │
│ - 통계청: 사업체 수                      │
│ - 업계 평균: 전환율, 해지율              │
│ - 물리 법칙: 시간, 제약                  │
│                                          │
│ 추정 가능:                               │
│ ✅ 디지털 도구 사용률: 30% (통계)        │
│ ✅ Freemium 전환율: 10% (통계)          │
└──────────────────────────────────────────┘
  │
  ▼
Output:
┌──────────────────────────────────────────┐
│ available_data:                          │
│ - 음식점 수: 70만 (확정)                 │
│ - 디지털 사용률: 30% (Layer 6 가능)      │
│ - 전환율: 10% (Layer 6 가능)             │
│                                          │
│ unknown_data:                            │
│ - 도입률 (직접 데이터 없음)              │
│ - ARPU (추정 필요)                       │
└──────────────────────────────────────────┘
```

---

## 🔄 Phase 2: 모형 생성 (상세)

```
Input: 
  - Question: "음식점 SaaS 시장은?"
  - Available: [음식점, 디지털, 전환]
  - Unknown: [도입률, ARPU]
  │
  ▼
┌──────────────────────────────────────────────────────────┐
│ LLM Prompt:                                              │
│ "이 질문에 답하기 위한 계산 모형을 5개 제시하세요.       │
│  가용 데이터를 최대한 활용하고                            │
│  Unknown은 최소화하세요.                                 │
│  변수는 2-6개로 제한하세요."                             │
└──────────────────────────────────────────────────────────┘
  │
  ▼
LLM 생성 결과:
┌──────────────────────────────────────────┐
│ Model 1: 직접 도입률                     │
│ formula: "시장 = 음식점 × 도입률 × ARPU" │
│ variables: 3개                           │
│ unknown: 2개 (도입률, ARPU)              │
│ score 예상: 낮음                         │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│ Model 2: 디지털 분해 ⭐                  │
│ formula: "시장 = 음식점 × 디지털 × 전환 × ARPU × 12" │
│ variables: 5개                           │
│ unknown: 1개 (ARPU만)                    │
│ score 예상: 높음!                        │
│                                          │
│ 논리:                                    │
│ "디지털 × 전환 = 도입률 근사"           │
│ "→ 도입률을 2개로 분해하여 해결!"       │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│ Model 3: Proxy                           │
│ formula: "시장 = 유사시장 × 비율"        │
│ variables: 2개                           │
│ unknown: 2개                             │
│ score 예상: 중간                         │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│ Model 4: 상세 분해                       │
│ formula: "시장 = 음식점 × 지역 × 디지털 × 인지 × 전환 × ARPU × 12" │
│ variables: 7개 (6개 + 상수)              │
│ unknown: 2개 (인지, ARPU)                │
│ score 예상: 낮음 (변수 많음)             │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│ Model 5: Bottom-up 합산                  │
│ formula: "시장 = Σ(세그먼트별 시장)"     │
│ variables: 6개 (각 세그먼트)             │
│ unknown: 많음                            │
│ score 예상: 낮음                         │
└──────────────────────────────────────────┘
  │
  ▼
Output: [Model 1, 2, 3, 4, 5]
```

---

## 🔍 Phase 3: 실행 가능성 체크 (퍼즐 맞추기!)

```
Input: candidate_models[5개]
  │
  ▼
For Model 2 (예시):
┌─────────────────────────────────────────────────────────────┐
│ Model 2: 시장 = 음식점 × 디지털 × 전환 × ARPU × 12          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Variable 1: 음식점 수                                        │
│ ├─ Available? YES ✅                                        │
│ └─ Value: 700,000 (확정)                                    │
│                                                             │
│ Variable 2: 디지털 사용률                                    │
│ ├─ Available? YES ✅                                        │
│ └─ Value: 0.30 (Layer 6 통계)                               │
│                                                             │
│ Variable 3: 전환율                                          │
│ ├─ Available? YES ✅                                        │
│ └─ Value: 0.10 (Layer 6 통계)                               │
│                                                             │
│ Variable 4: ARPU                                            │
│ ├─ Available? NO ❌                                         │
│ └─ 즉시 재귀 호출! (depth = 1)                              │
│     │                                                       │
│     └─ Recursive Call: "ARPU는?"                            │
│         ├─ Phase 2: 모형 생성                               │
│         │   → "ARPU = 기본료 + 추가료"                       │
│         ├─ Phase 3: 기본료, 추가료 재귀...                  │
│         └─ Phase 4: 재조립                                  │
│             → 80,000원 ✅                                   │
│                                                             │
│     # 향후 구현 (주석):                                     │
│     # Multi-Layer 우선 시도 (Layer 1-8)                     │
│     #   → 발견 시 재귀 불필요                                │
│     #   → 실패 시 재귀 호출                                  │
│                                                             │
│     Result: 80,000원 획득! ✅                               │
│                                                             │
│ Variable 5: 12개월                                          │
│ ├─ Available? YES ✅                                        │
│ └─ Value: 12 (상수)                                         │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 결과: 모든 변수 채움 ✅                                      │
│ Feasibility: TRUE                                           │
│ Score: 0.77 (Unknown 1개, Confidence 72%, 변수 5개, Depth 0)│
└─────────────────────────────────────────────────────────────┘
  │
  ▼
For Model 1 (비교):
┌─────────────────────────────────────────────────────────────┐
│ Model 1: 시장 = 음식점 × 도입률 × ARPU × 12                 │
├─────────────────────────────────────────────────────────────┤
│ Variable 1: 음식점 ✅ 700,000                               │
│ Variable 2: 도입률 ❌                                       │
│   └─ 재귀 호출: "도입률은?"                                  │
│       └─ Phase 2: 모형 생성 시도...                         │
│       └─ 복잡도 높음 → 점수 낮음                            │
│                                                             │
│ Variable 3: ARPU ❌                                         │
│   └─ 재귀 호출: "ARPU는?"                                   │
│                                                             │
│ 결과: Unknown 2개 → Depth 2단계 필요                        │
│ Feasibility: 낮음 (Model 2가 더 좋음)                       │
│                                                             │
│ # 향후 구현 (주석):                                         │
│ # Multi-Layer 시도 → 실패 → 대체 변수 탐색                  │
│ #   → "도입률 = 디지털 × 전환" 발견                         │
│ #   → Model 2 자동 생성                                     │
└─────────────────────────────────────────────────────────────┘
  │
  ▼
Ranking:
┌─────────────────────────────────────────┐
│ 1. Model 2: Score 0.77 ✅               │
│ 2. Model 3: Score 0.52                  │
│ 3. Model 4: Score 0.45                  │
│ 4. Model 1: INFEASIBLE                  │
│ 5. Model 5: INFEASIBLE                  │
└─────────────────────────────────────────┘
  │
  ▼
Selected: Model 2
```

---

## 🔄 Phase 3 재귀 예시 (ARPU가 재귀 필요한 경우)

```
Parent Call (Depth 0):
┌─────────────────────────────────────────────────────────────┐
│ Question: "음식점 SaaS 시장은?"                              │
│ Model: 시장 = 음식점 × 디지털 × 전환 × ARPU × 12            │
│ Unknown: ARPU                                               │
└─────────────────────────────────────────────────────────────┘
  │
  │ ARPU unknown → 즉시 재귀 호출! (depth = 1)
  │
  │ # 향후 구현 (주석):
  │ # Multi-Layer 우선 시도 → 실패 시 재귀
  ▼
Recursive Call (Depth 1):
┌─────────────────────────────────────────────────────────────┐
│ Question: "ARPU는?"                                         │
│ Phase 1: 초기 스캔                                          │
│   Available: 일부 구독료 참고값                             │
│   Unknown: 정확한 ARPU                                      │
│                                                             │
│ Phase 2: 모형 생성                                          │
│   Model A: ARPU = 기본료 + 추가료                           │
│   Model B: ARPU = 유사 SaaS ARPU                            │
│                                                             │
│ Phase 3: 실행 가능성                                        │
│   Model A:                                                  │
│     - 기본료: ❌ → Multi-Layer 시도                         │
│       ├─ Layer 7 (RAG): 50,000원 발견 ✅                    │
│     - 추가료: ❌ → Multi-Layer 시도                         │
│       ├─ Layer 1-6: 실패                                    │
│       └─ 재귀 호출? (depth = 2)                             │
└─────────────────────────────────────────────────────────────┘
  │
  │ 추가료를 재귀로 추정
  ▼
Recursive Call (Depth 2):
┌─────────────────────────────────────────────────────────────┐
│ Question: "추가료는?"                                        │
│ Model: 추가료 = 사용량 × 단가                               │
│                                                             │
│ Variables:                                                  │
│   - 사용량: ❌ → Multi-Layer                                │
│     └─ Layer 6 (통계): 1,000건 ✅                           │
│   - 단가: ❌ → Multi-Layer                                  │
│     └─ Layer 7 (RAG): 30원 ✅                               │
│                                                             │
│ 계산: 1,000 × 30 = 30,000원                                │
└─────────────────────────────────────────────────────────────┘
  │
  │ Backtrack (Depth 2 → 1)
  ▼
Back to Depth 1:
┌─────────────────────────────────────────────────────────────┐
│ ARPU 계산:                                                  │
│   기본료: 50,000원 (Depth 1, Layer 7)                       │
│   추가료: 30,000원 (Depth 2, 재귀 결과)                     │
│                                                             │
│ ARPU = 50,000 + 30,000 = 80,000원                          │
└─────────────────────────────────────────────────────────────┘
  │
  │ Backtrack (Depth 1 → 0)
  ▼
Back to Depth 0:
┌─────────────────────────────────────────────────────────────┐
│ 모든 변수 채움 완료:                                         │
│   음식점: 700,000                                           │
│   디지털: 0.30                                              │
│   전환: 0.10                                                │
│   ARPU: 80,000 (Depth 1 재귀 결과)                          │
│   12: 12                                                    │
│                                                             │
│ → Phase 4로!                                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 Phase 4: 재조립 (상세)

```
Input:
  Model: 시장 = 음식점 × 디지털 × 전환 × ARPU × 12
  Values: {음식점: 70만, 디지털: 0.3, ...}
  │
  ▼
┌──────────────────────────────────────────┐
│ Step 1: 계산 단계별 실행                 │
│                                          │
│ Step 1: 700,000 × 0.30                  │
│   = 210,000                              │
│   (디지털 도구 사용 음식점)              │
│                                          │
│ Step 2: 210,000 × 0.10                  │
│   = 21,000                               │
│   (유료 전환 음식점)                     │
│                                          │
│ Step 3: 21,000 × 80,000                 │
│   = 1,680,000,000                        │
│   (월 매출)                              │
│                                          │
│ Step 4: 1,680,000,000 × 12              │
│   = 20,160,000,000                       │
│   (연 매출)                              │
│                                          │
│ Final: 202억원                           │
└──────────────────────────────────────────┘
  │
  ▼
┌──────────────────────────────────────────┐
│ Step 2: Confidence 계산                  │
│                                          │
│ Variable Confidences:                    │
│ - 음식점: 0.80 (Layer 3 웹)             │
│ - 디지털: 0.60 (Layer 6 통계)           │
│ - 전환: 0.50 (Layer 6 통계)             │
│ - ARPU: 0.875 (Layer 7 RAG)             │
│ - 12: 1.00 (확정)                        │
│                                          │
│ 조합: geometric_mean                     │
│ = ⁵√(0.8×0.6×0.5×0.875×1.0)            │
│ = 0.72                                   │
└──────────────────────────────────────────┘
  │
  ▼
Output:
┌──────────────────────────────────────────────────────┐
│ FermiResult:                                         │
│   value: 202억원                                     │
│   confidence: 72%                                    │
│                                                      │
│   model:                                             │
│     formula: "시장 = 음식점 × 디지털 × 전환 × ARPU × 12" │
│     selection_reason: "Unknown 1개만, 모두 채움 가능" │
│                                                      │
│   components:                                        │
│     - 음식점: 70만 (Layer 3)                         │
│     - 디지털: 30% (Layer 6)                          │
│     - 전환: 10% (Layer 6)                            │
│     - ARPU: 8만원 (Layer 7)                          │
│                                                      │
│   calculation_steps:                                 │
│     1. 70만 × 0.3 = 21만                             │
│     2. 21만 × 0.1 = 2.1만                            │
│     3. 2.1만 × 8만 = 168억/월                        │
│     4. 168억 × 12 = 202억/년                         │
│                                                      │
│   alternative_models:                                │
│     - Model 1: Unknown 2개 (실행 불가)               │
│     - Model 3: 유사시장 데이터 부족                  │
└──────────────────────────────────────────────────────┘
```

---

## 🎯 Bottom-up ⟷ Top-down 반복 (핵심!)

```
초기 상태:
┌────────────────────┐
│ Bottom-up:         │
│ 알고 있는 것:      │
│ - 음식점: 70만     │
│ - 디지털: 30%      │
│ - 전환: 10%        │
└────────────────────┘

┌────────────────────┐
│ Top-down:          │
│ 목표:              │
│ - 시장 규모        │
└────────────────────┘
  │
  │ Iteration 1
  ▼
┌─────────────────────────────────────┐
│ Top-down: 모형 시도 1              │
│ "시장 = 음식점 × 도입률 × ARPU"    │
└─────────────────────────────────────┘
  │
  ├─ Bottom-up 검증: 도입률? ❌
  └─ Bottom-up 검증: ARPU? ❌
  │
  │ 2개 Unknown → 점수 낮음
  │
  │ Iteration 2
  ▼
┌─────────────────────────────────────┐
│ Top-down: 모형 시도 2              │
│ LLM: "도입률을 분해할 수 있나요?"  │
│ → "도입률 = 디지털 × 전환"         │
└─────────────────────────────────────┘
  │
  ├─ Bottom-up 검증: 디지털? ✅ (있음!)
  └─ Bottom-up 검증: 전환? ✅ (있음!)
  │
  │ 분해 성공! → 새 모형
  │
  │ Iteration 3
  ▼
┌─────────────────────────────────────┐
│ Top-down: 모형 시도 3              │
│ "시장 = 음식점 × 디지털 × 전환     │
│          × ARPU × 12"               │
└─────────────────────────────────────┘
  │
  ├─ Bottom-up: 음식점 ✅
  ├─ Bottom-up: 디지털 ✅
  ├─ Bottom-up: 전환 ✅
  ├─ Bottom-up: ARPU? → Multi-Layer
  │   └─ Layer 7 발견 ✅
  └─ Bottom-up: 12 ✅
  │
  │ 모든 변수 채움!
  ▼
┌─────────────────────────────────────┐
│ 퍼즐 완성! ✅                       │
│ 실행 가능한 모형 발견               │
└─────────────────────────────────────┘
```

---

## 🔁 재귀 흐름 (변수가 모형 필요)

```
Depth 0: "LTV는?"
┌─────────────────────────────────────┐
│ Model: LTV = ARPU × (1 / Churn)     │
│ Unknown: ARPU, Churn                │
└─────────────────────────────────────┘
  │
  ├─── ARPU 추정
  │      │
  │      │ Multi-Layer 실패
  │      │ → 재귀 호출 (Depth 1)
  │      ▼
  │    ┌──────────────────────────────┐
  │    │ Depth 1: "ARPU는?"           │
  │    │ Model: ARPU = 기본 + 추가    │
  │    │ Unknown: 기본, 추가          │
  │    └──────────────────────────────┘
  │      │
  │      ├─── 기본료
  │      │      │ Multi-Layer
  │      │      └─ Layer 7: 5만원 ✅
  │      │
  │      └─── 추가료
  │             │ Multi-Layer 실패
  │             │ → 재귀 (Depth 2)
  │             ▼
  │           ┌──────────────────────┐
  │           │ Depth 2: "추가료?"   │
  │           │ Model: 사용량 × 단가 │
  │           └──────────────────────┘
  │             │
  │             ├─ 사용량: Layer 6 → 1,000건
  │             └─ 단가: Layer 7 → 30원
  │             │
  │             │ 계산
  │             ▼
  │           추가료 = 1,000 × 30 = 30,000원
  │             │
  │             │ Backtrack
  │             ▼
  │      ┌──────────────────────────────┐
  │      │ Depth 1 계산:                │
  │      │ ARPU = 50,000 + 30,000       │
  │      │      = 80,000원               │
  │      └──────────────────────────────┘
  │      │
  │      │ Backtrack
  │      ▼
  └──── ARPU = 80,000원
  │
  │
  └─── Churn 추정
         │ Multi-Layer
         └─ Layer 6: 0.05 ✅ (재귀 불필요)
  │
  │ 모든 변수 채움
  ▼
┌─────────────────────────────────────┐
│ Depth 0 계산:                       │
│ LTV = 80,000 × (1 / 0.05)          │
│     = 80,000 × 20                   │
│     = 1,600,000원                   │
│                                     │
│ Max Depth Used: 2                   │
│ Recursive Calls: 2                  │
└─────────────────────────────────────┘
```

---

## 🚨 순환 감지 및 중단

```
Call Stack:
┌─────────────────────────────────────┐
│ Depth 0: "시장 규모는?"             │
│ Model: 시장 = 유사시장 × 점유율     │
└─────────────────────────────────────┘
  │
  ├─── 유사시장: Layer 3 → 300억 ✅
  │
  └─── 점유율
         │ Multi-Layer 실패
         │ → 재귀 (Depth 1)
         ▼
       ┌──────────────────────────┐
       │ Depth 1: "점유율은?"     │
       │ Model: 우리매출 / 시장   │
       └──────────────────────────┘
         │
         ├─── 우리매출: 알 수 있음
         │
         └─── 시장
                │ Multi-Layer 실패
                │ → 재귀 시도 (Depth 2)
                ▼
              ┌──────────────────┐
              │ "시장 규모는?"   │
              │ ← 순환 감지! 🚨 │
              └──────────────────┘
                │
                │ Call Stack 확인:
                │ [Depth 0: 시장,
                │  Depth 1: 점유율,
                │  Depth 2: 시장]  ← 중복!
                │
                ▼
              ┌──────────────────┐
              │ 재귀 중단!       │
              │ 대체 모형 시도   │
              └──────────────────┘
                │
                ▼
       ┌──────────────────────────────┐
       │ 대체: 점유율 = 업계 평균     │
       │ Layer 6 (통계): 15% ✅       │
       └──────────────────────────────┘
  │
  │ 순환 해결!
  ▼
┌─────────────────────────────────────┐
│ Depth 0 계산:                       │
│ 시장 = 300억 × 0.15 = 45억          │
└─────────────────────────────────────┘
```

---

## 🎯 의사결정 흐름

```
Question 입력
  │
  ▼
복잡한 추정인가?
  ├─ YES: Fermi Model Search
  │   ├─ Phase 1: 스캔
  │   ├─ Phase 2: 모형 생성
  │   ├─ Phase 3: 퍼즐 맞추기
  │   └─ Phase 4: 재조립
  │
  └─ NO: Multi-Layer 단일 값
      └─ Layer 1-8 순차 시도

모형 발견?
  ├─ YES: 실행 → 결과 반환
  │
  └─ NO: Fallback
      └─ Multi-Layer 단일 값 모드

변수 추정 중:
  Multi-Layer 성공?
  ├─ YES: 값 사용
  │
  └─ NO: 재귀 필요?
      ├─ Depth < 4: 재귀 호출
      │   └─ (위 프로세스 반복)
      │
      └─ Depth >= 4: 강제 Multi-Layer
```

---

## 📋 핵심 특징

### ✅ Fermi 본질 반영

1. **모형 만들기**: Phase 2 (LLM 생성)
2. **분해**: 변수 2-6개
3. **Bottom-up**: 가용 데이터 파악
4. **Top-down**: 개념 분해
5. **퍼즐 맞추기**: Phase 3 (채울 수 있나?)
6. **재귀**: 변수도 Guestimation (max depth 4)
7. **재조립**: Phase 4 (backtracking)

### ✅ 실용성

- 간단한 질문: Multi-Layer 직행
- 복잡한 질문: Fermi 모형
- Fallback: 항상 존재

---

**설계 문서**: `config/fermi_model_search.yaml` (1,113줄)  
**순서도**: 이 문서  
**상태**: ✅ 설계 완료, 검토 대기

이 순서도가 Fermi 본질(퍼즐 맞추기, Bottom-up ⟷ Top-down)을 잘 표현했나요?
