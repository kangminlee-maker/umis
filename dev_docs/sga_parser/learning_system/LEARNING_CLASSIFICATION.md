# A등급 달성 학습 내용 분류

**작성일**: 2025-11-14  
**목적**: 규칙 기반 vs LLM 기반 개선 분류

---

## 🎯 학습 내용 분류 체계

### **규칙 기반 (Rule-based)** ✅
- 명확한 패턴
- 100% 재현 가능
- 비용 $0
- 빠른 처리

### **LLM 기반 (LLM-based)** 🤖
- 컨텍스트 이해 필요
- 구조 분석 필요
- 비용 ~$0.003
- 복잡한 케이스

---

## 📊 A등급 달성 학습 내용

### ✅ **규칙 기반 개선 (7개)**

#### **1. 합계 항목 제외 (정규식)**
**학습**:
- "합계", "합 계", "합  계" 등 공백 변형
- "총계", "소계"
- "판매비와관리비", "판관비" 등 전체 합계

**규칙화**:
```python
# 공백 무관 정규식
if re.match(r'^(합|총|소)\s*계$', item_name.strip()):
    continue

# 판관비 합계 패턴
if re.search(r'(판매비|관리비|판관비|영업비용).*합계', item_name):
    continue
```

**적용 케이스**:
- ✅ LG생활건강: "합계" 15,273억 제거 → A등급
- ✅ LG전자: "합 계" 81,897억 제거 → A등급

**판단**: 100% 규칙화 가능 ✅

---

#### **2. 매출원가 키워드 강화**
**학습**:
- "재료비", "원재료", "부재료"
- "제품", "재공품", "상품의 변동"
- "외주가공비", "외주용역비"
- "종업원 급여" (제조인력)

**규칙화**:
```python
exclude_keywords = [
    '재료비', '원재료', '부재료',
    '제품', '재공품', '상품', '제품의 변동',
    '외주가공비', '외주용역비', '외주비',
    '종업원 급여',
]
```

**적용 케이스**:
- ✅ BGF리테일: 매출원가 제외 시도 (섹션 문제로 실패)

**판단**: 100% 규칙화 가능 ✅

---

#### **3. 대소문자 무시 매칭**
**학습**:
- "Total", "Subtotal", "Sum" 등 영문 합계
- 대소문자 구분 없이 매칭 필요

**규칙화**:
```python
item_name_lower = item_name.lower()
if any(keyword.lower() in item_name_lower for keyword in exclude_keywords):
    continue
```

**판단**: 100% 규칙화 가능 ✅

---

#### **4. "연결" 키워드 체크**
**학습**:
- "연결재무제표" vs "별도재무제표"
- 섹션 제목 또는 내용 초반 500자

**규칙화**:
```python
# 섹션 점수 계산 시
if '연결' in title or '연결' in section_text[:500]:
    score -= 50  # 큰 패널티
```

**판단**: 100% 규칙화 가능 ✅

---

#### **5. 표준 계정 10개 임계값 (60%)**
**학습**:
- 16개 표준 SG&A 계정 정의
- 10개 이상 (60%) 포함된 섹션만 선택
- 잘못된 섹션 자동 제외

**규칙화**:
```python
if standard_account_count >= 10:
    candidate_sections.append(section)
```

**적용 케이스**:
- ✅ 모든 A등급 기업 (10-18개 표준 계정 포함)

**판단**: 100% 규칙화 가능 ✅

---

#### **6. "당기" 키워드 체크**
**학습**:
- 섹션 초반 2,000자에 "당기" 포함 확인
- 전기 데이터 제외

**규칙화**:
```python
if '당기' in section_text[:2000]:
    score += 10
```

**판단**: 100% 규칙화 가능 ✅

---

#### **7. COGS 키워드 감지 (-100점)**
**학습**:
- "상품매입", "원재료" 등 COGS 시그널
- 매출원가 섹션 강력 제외

**규칙화**:
```python
if '상품매입' in section_preview or '원재료' in section_preview:
    score -= 100
```

**판단**: 100% 규칙화 가능 ✅

---

### 🤖 **LLM 기반 개선 (4개)**

#### **1. 복잡한 구조 인식 (SK하이닉스)**
**학습**:
- "소계" 위: 일반 SG&A 항목들의 합
- "소계" 아래: 경상개발비 (연구개발비 총지출액 - 개발비 자산화)
- 최종: 소계 + 경상개발비 = 판매비와관리비

**구조**:
```
급여                    8,000억
지급수수료               7,000억
...
소계                   32,000억  ← 위 항목들의 합

연구개발비 총지출액        40,000억
개발비 자산화             10,000억
경상개발비               30,000억  ← 계산된 값

판매비와관리비            62,000억  ← 소계 + 경상개발비
```

**규칙화 불가 이유**:
- 소계의 의미가 위치에 따라 다름
- 계산 로직이 숨어있음 (총지출액 - 자산화)
- 섹션마다 구조가 다를 수 있음

**LLM 필요성**:
- 구조 이해 및 분석
- 어떤 항목이 실제 SG&A인지 판단
- 계산 로직 파악

**판단**: LLM 필수 🤖

---

#### **2. 다중 섹션 중 최적 선택**
**학습**:
- 같은 "판매비와관리비" 섹션이 여러 개 존재
- 내용을 봐야 어느 것이 올바른지 판단 가능

**규칙화 한계**:
- 점수 계산으로는 완벽하지 않음
- 항목 개수, COGS 체크만으로는 부족
- 실제 내용 이해 필요

**LLM 필요성**:
- 각 섹션의 샘플 항목 비교
- "이 섹션이 세부 항목 테이블인가?" 판단
- 연결/별도, 당기/전기 구분

**적용 케이스**:
- C/D등급에서 자동 활성화
- 3중 검증 (당기/잘못된계정/연결)

**판단**: LLM 보완 🤖

---

#### **3. 애매한 계정 분류**
**학습**:
- "종업원급여": 제조인력(COGS) vs 관리인력(SG&A)
- "컨텐츠제작비": 제작원가(COGS) vs 마케팅(SG&A)
- "연구개발비": 자산화(무형자산) vs 비용화(SG&A)

**규칙화 한계**:
- 산업별, 기업별 회계 정책 다름
- 컨텍스트 없이는 분류 불가

**LLM 필요성**:
- 주변 항목 분석
- 산업 특성 고려
- 금액 규모 판단

**판단**: LLM 보완 🤖

---

#### **4. 품질 검증 후 재판단**
**학습**:
- D등급 발생 시 LLM으로 섹션 재검증
- "정말 이 섹션이 맞는가?" 질문
- 다른 섹션 제안

**규칙화 불가 이유**:
- 이미 규칙으로 최선을 다했음
- 추가 개선은 이해력 필요

**LLM 필요성**:
- 전체 맥락 이해
- 문제점 발견
- 대안 제시

**판단**: LLM 필수 🤖

---

## 📋 개선 우선순위

### **Phase 1: 규칙 기반 강화** (즉시 적용 가능)

**1. 합계 항목 완벽 제거** ✅ (완료)
```python
# 이미 구현됨
if re.match(r'^(합|총|소)\s*계$', item_name.strip()):
    continue
```

**2. 매출원가 키워드 확장** ✅ (완료)
```python
# 이미 구현됨
exclude_keywords = [...]
```

**3. 표준 계정 임계값** ✅ (완료)
```python
# 이미 구현됨
min_standard_accounts=10
```

---

### **Phase 2: LLM 기반 보강** (SK하이닉스 케이스)

**1. 구조 인식 파싱** ⭐ (신규)
```python
def parse_complex_structure_with_llm(section_text):
    """
    복잡한 구조 (소계, 계산 로직 등) LLM 파싱
    
    케이스:
    - SK하이닉스: 소계 위/아래 의미 다름
    - 계산된 항목 (총지출액 - 자산화 = 경상개발비)
    """
    
    prompt = f"""
당신은 한국 재무제표 전문가입니다.

**임무**: 아래 판매비와관리비 섹션을 분석하여 **실제 SG&A 항목만** 추출하세요.

**섹션 내용**:
{section_text[:5000]}

**주의사항**:
1. "소계", "합계" 등은 제외하세요
2. 소계 위의 항목들은 일반적으로 실제 SG&A입니다
3. 소계 아래에 추가 항목이 있으면:
   - 계산된 값인지 확인 (예: 총지출액 - 자산화 = 경상개발비)
   - 실제 SG&A인지 판단
4. 경상연구개발비는 **포함** (비용화된 연구개발비)
5. 개발비 자산화는 **제외** (무형자산)

**응답 형식** (JSON):
{{
    "sga_items": [
        {{"name": "급여", "amount": "829260"}},
        {{"name": "복리후생비", "amount": "220675"}},
        ...
    ],
    "excluded_items": [
        {{"name": "소계", "reason": "합계 항목"}},
        {{"name": "개발비 자산화", "reason": "무형자산 (SG&A 아님)"}}
    ],
    "structure_analysis": "소계 위 13개 항목 + 소계 아래 경상개발비 1개 = 총 14개 실제 SG&A",
    "confidence": 0.95
}}
"""
    
    return llm.ask(prompt)
```

**2. 다중 섹션 심층 비교** ⭐ (개선)
```python
# 현재: 10개 샘플 항목만
# 개선: 전체 구조 분석 + 비교
```

**3. D등급 LLM 재파싱** ⭐ (신규)
```python
if quality.grade == 'D':
    # 현재: 검증만
    # 개선: 재파싱 시도
    llm_result = parse_complex_structure_with_llm(section_text)
    items = llm_result['sga_items']
    quality = validate_quality(items, ...)
```

---

## 🎯 SK하이닉스 해결 전략

### **문제 분석**

**구조**:
```
24. 판매비와관리비
(단위: 백만원)

급여                    829,260
퇴직급여                 35,537
복리후생비               220,675
지급수수료               769,489
감가상각비               304,389
무형자산상각비            282,685
운반보관비                53,680
세금과공과                85,672
광고선전비                83,575
소모품비                 120,607
판매촉진비               117,811
품질관리비                48,465
기타                    401,099
---------------
소계                  3,352,944  ← 위 13개 항목의 합

연구개발비 총지출액      4,006,166
개발비 자산화           -833,133
---------------
경상개발비             3,173,033  ← 계산됨

판매비와관리비          6,525,977  ← 소계 + 경상개발비
```

**규칙 기반 시도**:
- "소계" 제외 → 13개 항목만 파싱 (3,353억)
- "경상개발비" 포함 → 제외됨 (exclude_keywords)
- 결과: 3,353억 (DART 6,248억의 53%, -46%)

**문제**:
- 경상개발비를 제외해서는 안 됨
- 하지만 "개발비"는 일반적으로 exclude_keywords
- 구조를 이해해야만 올바르게 파싱 가능

---

### **해결 방안: LLM 구조 파싱**

**Step 1: 구조 인식**
```python
# LLM에게 전체 섹션 제공
# "소계 위/아래를 분석하고, 실제 SG&A만 추출"
```

**Step 2: 계산 로직 이해**
```python
# "연구개발비 총지출액 - 개발비 자산화 = 경상개발비"
# LLM이 이 계산을 이해하고, 경상개발비를 포함
```

**Step 3: 검증**
```python
# 소계 + 경상개발비 = 판매비와관리비
# 합계 검증으로 정확도 확인
```

---

## 📊 규칙 vs LLM 비율

### **현재 (A등급 4개 기준)**

**규칙 기반**: 100% (합계 제외, 키워드 필터)  
**LLM 보완**: 0% (A등급은 LLM 미사용)

### **개선 후 (SK하이닉스 포함)**

**규칙 기반**: 70% (간단한 케이스)  
**LLM 파싱**: 30% (복잡한 구조)

### **비용 영향**

**현재**:
- A등급: $0
- D등급: $0.003 (검증만)

**개선 후**:
- A등급: $0
- D등급 (구조 파싱): **$0.01** (긴 프롬프트)

---

## ✅ 최종 권장 사항

### **규칙 기반으로 추가** (7개 완료)
1. ✅ 합계 항목 정규식
2. ✅ 매출원가 키워드 확장
3. ✅ 대소문자 무시
4. ✅ "연결" 체크
5. ✅ 표준 계정 10개
6. ✅ "당기" 체크
7. ✅ COGS 감지

### **LLM으로 보강** (신규 4개)
1. ⭐ **구조 인식 파싱** (SK하이닉스)
2. 🔄 다중 섹션 심층 비교 (개선)
3. ⭐ D등급 LLM 재파싱 (신규)
4. 🔄 애매한 계정 분류 (보완)

---

**다음 단계**: LLM 구조 파싱 로직 구현 🚀




