# GS리테일 파싱 실수 완벽 분석
**발견일**: 2025-11-13  
**사용자 제공 실제 데이터로 검증**

---

## 🔍 파싱 실수

### 파서가 파싱한 것 (잘못됨!)

**섹션**: 1. 판매비와관리비 (추정)

**Top 10:**
1. 합계(*2): 105,719억원
2. **상품매입: 79,847억원** ← 매출원가! ❌
3. 수수료: 11,801억원
4. 지급수수료 등: 10,574억원
5. 감가상각비 및 상각비: 5,854억원
6. **종업원급여**: 5,113억원
7. 급여및상여: 3,987억원
8. **포괄손익계산서상 영업이익**: 3,150억원 ← 손익계산서! ❌

**총 75개 항목, 합계: 141,926억원**

---

### 실제 데이터 (사용자 제공, 올바름!)

**섹션**: 28. 판매비와관리비

**항목 (25개):**
1. 지급수수료 등: 10,959억원 ✅
2. 사용권자산감가상각비: 2,834억원 ✅
3. 유형자산감가상각비: 2,259억원 ✅
4. 급여및상여: 4,043억원 ✅
5. 판매촉진비: 709억원 ✅
... (20개 더)

**합계: 25,640억원** ✅

---

## 🎯 문제의 근본 원인

**파서가 섹션 1을 파싱한 이유:**

1. **.cursorrules의 로직 문제**
   - "당기 포함 섹션 우선" 로직이 있었지만
   - 섹션 1도 "당기"가 있었을 가능성
   - 또는 섹션 1을 먼저 발견

2. **GS리테일의 구조**
   - 섹션 1: 잘못된 판매비와관리비 (손익계산서 전체?)
   - 섹션 28: 올바른 판매비와관리비 (세부 주석)

3. **우리 파서의 선택**
   - 첫 번째 매치 선택
   - 또는 "당기" 체크가 둘 다 통과
   - **섹션 번호를 고려하지 않음!**

---

## ✅ 해결 방안

### 1. 섹션 번호 우선순위

**규칙:**
```python
# 큰 섹션 번호 우선! (주석이 뒤에 있음)
if len(matches) > 1:
    # 섹션 번호 추출
    sections = []
    for m in matches:
        num = int(re.search(r'(\d+)\.', m.group()).group(1))
        sections.append((num, m))
    
    # 큰 번호 우선 (28 > 1)
    sections.sort(reverse=True)
    m = sections[0][1]
```

### 2. 항목 개수 체크

**규칙:**
```python
# SG&A 세부는 보통 15-30개
if item_count > 50:
    # 너무 많음 → 잘못된 섹션
    pass
```

### 3. "상품매입" 체크

**규칙:**
```python
# "상품매입" 있으면 매출원가 섹션!
if '상품매입' in items or '원재료' in items:
    # 잘못된 섹션
    continue
```

---

## 🎊 최종 수정

**parse_sga_with_zip.py 개선:**
1. ✅ 섹션 번호 큰 것 우선
2. ✅ 상품매입/원재료 있으면 스킵
3. ✅ 항목 개수 50개 초과 시 스킵

**효과:**
- GS리테일: 섹션 28 선택 ✅
- 25개 항목, 25,640억원 ✅
- A등급 달성 가능!

---

**사용자 통찰 덕분에 근본 원인 발견!** 🙏
