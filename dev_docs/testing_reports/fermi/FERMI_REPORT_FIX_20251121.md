# Fermi 보고서 계산 연결 문제 수정

**날짜**: 2025-11-21  
**문제**: 분해 과정과 최종 계산식 불일치  
**해결**: 전체 분해 과정 표시로 수정

---

## 🔍 발견된 문제

### 문제점
보고서에서 분해 과정은 **처음 4단계만** 표시했지만, 최종 계산식은 **보이지 않는 단계**를 참조함.

### 예시: gpt-5.1 (chat)

**Before (문제)**:
```
분해 과정 (요약):
1. 한국 인구: 52,000,000
2. 경활 비율: 0.62
3. 경활 인구: 32,240,000
4. 자영업 비율: 0.2

최종 계산식: step9 + step11 = 6,190,080 + 1,547,520
```

❌ **문제**: step9, step11이 어디서 나왔는지 불명확!

**After (수정)**:
```
분해 과정 (12단계):
1. 한국 인구: 52,000,000
2. 경활 비율: 0.62
3. 경활 인구: 32,240,000 (= step1 × step2)
4. 자영업 비율: 0.2
5. 자영업 인원: 6,448,000 (= step3 × step4)
6. 등록 비율: 0.8
7. 등록 자영업: 5,158,400 (= step5 × step6)
8. 1인당 등록: 1.2개
9. 개인사업자: 6,190,080 (= step7 × step8)
10. 법인/개인 비율: 0.25
11. 법인사업자: 1,547,520 (= step9 × step10)
12. 전체 사업자: 7,737,600 (= step9 + step11)

최종 계산식: step9 + step11 = 6,190,080 + 1,547,520 = 7,737,600 ≈ 7,700,000
```

✅ **해결**: 전체 분해 과정 표시로 계산 연결 명확!

---

## 📝 수정 내역

### 1. 보고서 수정

**파일**: `docs/FERMI_COMPREHENSIVE_REPORT_20251121_165419.md`

| 모델 | 원래 표시 | 수정 후 | 상태 |
|------|----------|---------|------|
| gpt-5.1 (chat) | 4단계 | **12단계** | ✅ 수정 완료 |
| gpt-5.1 (responses) | 4단계 | **6단계** | ✅ 수정 완료 |
| gpt-4o-mini | 4단계 | **9단계** | ✅ 수정 완료 |

**수정 내용**:
- 전체 분해 과정 표시 (간략 형식)
- 각 단계의 계산식 포함
- 최종 계산식과 일치 확인

### 2. 스크립트 수정

**파일**: `scripts/test_fermi_final_fewshot.py`

**Before (659번째 줄)**:
```python
for i, step in enumerate(decomp[:4], 1):  # 처음 4단계만
    f.write(f"{i}. {step.get('step', 'N/A')}: {step.get('value', 'N/A')}\n")
    if 'calculation' in step:
        calc = step['calculation'][:100]
        f.write(f"   - 계산: {calc}\n")
```

**After**:
```python
f.write(f"**분해 과정** ({len(decomp)}단계, 간략):\n")
for i, step in enumerate(decomp, 1):  # 전체 단계
    step_name = step.get('step', 'N/A')
    step_val = step.get('value', 'N/A')
    
    # 값 포맷팅 (1000 이상은 콤마)
    if isinstance(step_val, (int, float)) and step_val > 1000:
        step_val_str = f"{step_val:,}"
    else:
        step_val_str = str(step_val)
    
    # 계산식 간략히 (60자 이상은 자름)
    calc = step.get('calculation', '')
    if calc and len(calc) > 60:
        calc = calc[:57] + "..."
    
    # 한 줄로 표시
    if calc:
        f.write(f"{i}. {step_name}: {step_val_str} ({calc})\n")
    else:
        f.write(f"{i}. {step_name}: {step_val_str}\n")
```

**개선 사항**:
- ✅ 전체 분해 과정 표시
- ✅ 단계 수 명시 (예: "12단계")
- ✅ 값 포맷팅 (콤마 추가)
- ✅ 계산식 간략화 (60자 제한)
- ✅ 한 줄 형식으로 가독성 향상

---

## ✅ 수정 검증

### 1. gpt-5.1 (chat) - 12단계

```
1. 한국 인구: 52,000,000
2. 경활 비율: 0.62
3. 경활 인구: 32,240,000 (= step1 × step2)
4. 자영업 비율: 0.2
5. 자영업 인원: 6,448,000 (= step3 × step4)
6. 등록 비율: 0.8
7. 등록 자영업: 5,158,400 (= step5 × step6)
8. 1인당 등록: 1.2개
9. 개인사업자: 6,190,080 (= step7 × step8)
10. 법인/개인 비율: 0.25
11. 법인사업자: 1,547,520 (= step9 × step10)
12. 전체 사업자: 7,737,600 (= step9 + step11)

최종: step9 + step11 = 6,190,080 + 1,547,520 = 7,737,600 ✓
```

✅ **검증**: step9과 step11이 분해 과정에 명확히 표시됨!

### 2. gpt-5.1 (responses) - 6단계

```
1. 한국 인구: 52,000,000
2. 경활 인구: 32,240,000 (= 52,000,000 × 0.62)
3. 사업주 수: 5,800,000 (= 32,240,000 × 0.18)
4. 1인당 등록 1.2개: 7,000,000 (= 5,800,000 × 1.2)
5. 법인 사업자: 1,750,000 (= 7,000,000 × 0.25)
6. 개인 사업자: 5,250,000 (= 7,000,000 - 1,750,000)

최종: step5 + step6 = 1,750,000 + 5,250,000 = 7,000,000 ✓
```

✅ **검증**: step5와 step6이 분해 과정에 명확히 표시됨!

### 3. gpt-4o-mini - 9단계

```
1. 한국 인구: 51,000,000
2. 경활 비율: 0.65
3. 경활 인구: 33,150,000 (= step1 × step2)
4. 자영업 비율: 0.26
5. 자영업자: 8,620,000 (= step3 × step4)
6. 법인 비율: 0.15
7. 법인 사업자: 4,972,500
8. 다중 비율: 1.1
9. 전체 사업자: 4,000,000

최종: [(step5 + step7) / step8] = [(8,620,000 + 4,972,500) / 1.1] ✓
```

✅ **검증**: step5, step7, step8이 분해 과정에 명확히 표시됨!

---

## 🎯 개선 효과

### Before (문제)

```
❌ 분해 과정: 4단계만 표시
❌ 최종 계산식: 보이지 않는 단계 참조
❌ 사용자 혼란: "step9은 어디서 나온 거지?"
```

### After (수정)

```
✅ 분해 과정: 전체 단계 표시 (6-12단계)
✅ 최종 계산식: 모든 단계 명확히 추적 가능
✅ 사용자 이해: 계산 연결 완벽
```

---

## 📋 향후 개선 사항

### 1. 자동 검증 강화

현재 스크립트는 `auto_verify_calculation()` 함수로 계산을 검증하지만, 추가 개선 가능:

```python
def verify_calculation_trace(decomp, final_value):
    """
    최종 계산식이 분해 과정의 어느 단계를 참조하는지 자동 추적
    """
    # step1, step2 등을 정규표현식으로 찾기
    # 해당 단계가 decomp에 존재하는지 확인
    # 없으면 경고 출력
    pass
```

### 2. 보고서 형식 개선

현재는 간략 형식이지만, 더 상세한 옵션 제공:

```python
# 옵션 1: 간략 (현재)
1. 한국 인구: 52,000,000

# 옵션 2: 상세
1. 한국 인구
   - 값: 52,000,000
   - 계산: 약 5200만명으로 가정
   - 근거: 통계청 데이터
```

### 3. 계산 일관성 체크

gpt-4o-mini의 최종 계산식에서 발견된 문제:

```
계산식: [(8,620,000 + 4,972,500) / 1.1] = 4,000,000
실제: (8,620,000 + 4,972,500) / 1.1 = 12,356,818

→ 모델이 계산을 잘못했음!
```

**제안**: 계산식을 실제로 실행하여 결과와 비교

```python
def verify_formula(formula_str, expected_value):
    """
    final_calculation의 수식을 파싱하여 실제 계산 수행
    결과가 value와 일치하는지 확인
    """
    # eval() 사용 (안전하게)
    # 결과 비교
    # 불일치 시 경고
    pass
```

---

## 🎉 결론

### ✅ 수정 완료

1. **보고서**: 전체 분해 과정 표시 (3개 모델)
2. **스크립트**: 향후 보고서 생성 시 전체 단계 표시
3. **검증**: 문법 체크 통과

### 💡 핵심 교훈

**Fermi 추정 보고서의 필수 요소**:

1. ✅ **전체 분해 과정 표시**
   - 처음 몇 단계만 보여주면 안 됨
   - 최종 계산식에 사용된 단계까지 필수

2. ✅ **계산 연결 명확성**
   - 각 단계의 계산식 표시
   - step 참조가 명확해야 함

3. ✅ **사용자 친화성**
   - 간략하지만 완전한 정보
   - 콤마 포맷팅으로 가독성 향상

### 📁 수정된 파일

1. `docs/FERMI_COMPREHENSIVE_REPORT_20251121_165419.md` ✅
2. `scripts/test_fermi_final_fewshot.py` ✅
3. `docs/FERMI_REPORT_FIX_20251121.md` (이 문서) ✅

---

**다음 단계**: 나머지 문제들(서울 인구, 커피점)도 같은 방식으로 확인하여 일관성 유지

