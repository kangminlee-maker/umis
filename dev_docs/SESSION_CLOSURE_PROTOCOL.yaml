# ========================================
# UMIS 세션 마무리 가이드
# Session Closure Protocol v1.0
# ========================================
# @purpose: AI가 세션 종료 시 체크리스트 실행
# @trigger: 사용자가 "/umis close" 또는 "세션 종료" 입력
# ========================================

version: 1.0
created: 2025-11-27
format: yaml
audience: ai_agent

# ========================================
# STEP 0: 파일 정리 및 이동
# ========================================

file_organization:
  purpose: "개발 과정에서 생성된 파일을 적합한 폴더로 이동"
  
  rules:
    
    # 루트 폴더 정리 (최우선!)
    root_cleanup:
      rule: "루트에 생성된 .md 파일은 반드시 이동"
      patterns:
        - "*.md (루트) → 적절한 폴더"
        - "CURSOR_*.md → docs/guides/"
        - "SESSION_*.md, SESSION_*.yaml → dev_docs/session_summaries/"
        - "*_GUIDE.md → docs/guides/"
        - "*_SUMMARY.md → dev_docs/session_summaries/"
      
      exceptions:
        keep_in_root:
          - "README.md"
          - "CHANGELOG.md"
          - "CONTEXT_WINDOW_STRATEGY.md"
    
    # 개발 문서
    development_docs:
      target: "dev_docs/"
      
      by_category:
        session_summaries:
          target: "dev_docs/session_summaries/"
          patterns:
            - "SESSION_SUMMARY_*.md"
            - "SESSION_SUMMARY_*.yaml"
          naming: "SESSION_SUMMARY_YYYYMMDD_HHMM_keyword1_keyword2.yaml"
        
        improvements:
          target: "dev_docs/improvements/"
          patterns:
            - "*_IMPLEMENTATION*.md"
            - "*_REFACTOR*.md"
            - "*_OPTIMIZATION*.md"
            - "*_FIX*.md"
        
        testing_reports:
          target: "dev_docs/testing_reports/"
          patterns:
            - "*_TEST_*.md"
            - "*_REPORT*.md"
            - "BENCHMARK_*.md"
        
        issues:
          target: "dev_docs/issues/"
          patterns:
            - "ISSUE_*.md"
            - "BUG_*.md"
            - "ERROR_*.md"
        
        analysis:
          target: "dev_docs/analysis/"
          patterns:
            - "*_ANALYSIS*.md"
            - "*_COMPARISON*.md"
    
    # 사용자 문서
    user_docs:
      target: "docs/"
      
      by_category:
        guides:
          target: "docs/guides/"
          patterns:
            - "*_GUIDE.md"
            - "HOW_TO_*.md"
            - "*_SETUP*.md"
            - "CURSOR_*.md"
        
        architecture:
          target: "docs/architecture/"
          patterns:
            - "*_ARCHITECTURE*.md"
            - "*_DESIGN*.md"
            - "SYSTEM_*.md"
        
        api:
          target: "docs/api/"
          patterns:
            - "*_API*.md"
            - "API_*.md"
    
    # 스크립트
    scripts:
      target: "scripts/"
      patterns:
        - "*.py (루트) → scripts/"
        - "test_*.py → tests/unit/ 또는 tests/integration/"
      exceptions:
        - "setup.py → setup/"
    
    # 설정 파일
    config:
      target: "config/"
      patterns:
        - "*_config*.yaml → config/"
        - "*_registry*.yaml → config/"
      exceptions:
        - "umis.yaml, umis_core.yaml, umis_*.yaml → 루트 유지"
    
    # 데이터 파일
    data:
      target: "data/"
      patterns:
        - "*.jsonl → data/raw/"
        - "*_patterns.yaml → data/raw/"
        - "*.csv, *.xlsx → data/quantifier/"
    
    # 임시 파일 삭제
    temporary_files:
      delete:
        - "*_temp.py"
        - "*_test.json"
        - "*_backup.yaml"
        - ".DS_Store"
        - "*.pyc"
        - "__pycache__/"
    
    # 아카이브
    archive:
      target: "archive/"
      when: "더 이상 사용하지 않는 파일"
      patterns:
        - "DEPRECATED_*.md"
        - "OLD_*.py"
        - "v[0-6]_*.md"

  execution:
    command_sequence:
      - "ls *.md | grep -v 'README\\|CHANGELOG\\|CONTEXT_WINDOW'"
      - "# 발견된 각 파일에 대해 규칙 적용"
      - "mv {file} {target_folder}/"
      - "git add {moved_files}"

# ========================================
# STEP 1: 세션 서머리 작성
# ========================================

session_summary:
  purpose: "작업 내용 정리 + 다음 세션을 위한 컨텍스트 보존"
  
  file_naming:
    format: "SESSION_SUMMARY_{date}_{time}_{keyword1}_{keyword2}.yaml"
    example: "SESSION_SUMMARY_20251127_1430_cursorrules_optimization.yaml"
    location: "dev_docs/session_summaries/"
  
  structure:
    metadata:
      fields:
        - session_date: "2025-11-27"
        - session_time: "14:30-16:45"
        - duration: "2h 15min"
        - branch: "alpha"
        - version_before: "v7.11.0"
        - version_after: "v7.11.1"
        - keywords: ["cursorrules", "optimization", "system_rag"]
    
    summary:
      fields:
        - objective: "세션 목표 (1-2문장)"
        - achievements: "완료된 작업 (bullet points)"
        - key_decisions: "주요 결정사항 및 이유"
        - technical_changes: "기술적 변경사항 (파일별)"
    
    context_for_next_session:
      fields:
        - remaining_tasks: "미완료 작업 리스트 (우선순위 포함)"
        - blocked_items: "막힌 작업 + 이유"
        - required_context: "다음 세션에 필요한 컨텍스트"
        - files_to_review: "검토 필요 파일 목록"
        - key_insights: "작업 중 발견한 중요 인사이트"
        - errors_encountered: "발생한 오류 및 해결 방법"
        - terminal_commands: "재사용 가능한 명령어"
    
    dependencies:
      fields:
        - modified_files: "수정된 파일 목록 (경로 포함)"
        - dependency_chain: "파일 간 의존성"
        - update_required: "연쇄 업데이트 필요 파일"
    
    next_steps:
      fields:
        - immediate: "즉시 해야 할 작업 (Top 3)"
        - short_term: "단기 작업 (1주일)"
        - long_term: "장기 작업 (1개월)"
        - optional: "선택적 개선사항"

# ========================================
# STEP 2: UMIS_ARCHITECTURE_BLUEPRINT.md 업데이트
# ========================================

architecture_update:
  purpose: "아키텍처 문서를 항상 최신 상태로 유지"
  file: "docs/architecture/UMIS_ARCHITECTURE_BLUEPRINT.md"
  
  check_process:
    1_compare_changes:
      action: "세션에서 변경된 내용과 현재 문서 비교"
      focus_areas:
        - "시스템 구조 변경"
        - "Agent 역할 변경"
        - "워크플로우 변경"
        - "RAG 구조 변경"
        - "도구/명령어 추가"
    
    2_identify_updates:
      check_sections:
        - "System Overview"
        - "Agent Definitions"
        - "Workflow Diagrams"
        - "RAG Architecture"
        - "File Structure"
    
    3_update_metadata:
      required_fields:
        - version: "v7.11.1"
        - updated: "2025-11-27"
        - alpha_branch_commit: "git rev-parse alpha"
        - alpha_branch_date: "git log -1 --format=%cd alpha"
        - main_branch_commit: "git rev-parse main (if synced)"
        - main_branch_date: "git log -1 --format=%cd main (if synced)"
        - last_sync: "alpha와 main 마지막 동기화 날짜"
      
      metadata_location: "문서 상단 YAML frontmatter"
    
    4_remove_changelog:
      rule: "CHANGELOG 내용 제거 (현재 상태만 유지)"
      note: "변경 이력은 CHANGELOG.md로"
  
  update_commands:
    - "Read current UMIS_ARCHITECTURE_BLUEPRINT.md"
    - "Compare with session changes"
    - "Update changed sections"
    - "Update metadata (commits, dates)"
    - "Verify no changelog content"

# ========================================
# STEP 3: umis.yaml 업데이트 및 의존성 파악
# ========================================

umis_yaml_update:
  purpose: "umis.yaml 변경사항 반영 + 의존성 체인 파악"
  file: "umis.yaml"
  
  update_process:
    1_identify_changes:
      check_sections:
        - "system: (SECTION 1)"
        - "agents: (SECTION 6)"
        - "implementation_guide: (SECTION 8)"
        - "ai_onboarding: (신규)"
      
      compare_with: "세션 작업 내용"
    
    2_update_sections:
      action: "변경된 섹션 수정"
      validate: "YAML 문법 검증"
    
    3_dependency_mapping:
      purpose: "수정으로 영향받는 파일 식별"
      
      dependency_chain:
        umis_yaml_changes:
          affects:
            - "umis_core.yaml (INDEX 업데이트 필요)"
            - "tool_registry.yaml (자동 생성)"
            - "System RAG (재구축 필요)"
            - ".cursorrules (참조 업데이트 필요)"
            - "UMIS_AI_REFERENCE.json (재생성 필요)"
        
        agent_section_changes:
          affects:
            - "tool:{agent}:complete (자동 재생성)"
            - "해당 Agent 문서 (docs/ 또는 dev_docs/)"
        
        system_section_changes:
          affects:
            - "tool:system:{section} (자동 재생성)"
            - "관련 가이드 문서"
      
      modification_scope:
        rule: "한 섹션 수정 시 영향 범위 명시"
        example:
          modified: "agents.observer"
          impacts:
            - "tool:observer:complete (자동)"
            - "tool:system:agents (자동)"
            - "UMIS_ARCHITECTURE_BLUEPRINT.md (수동)"
            - "docs/guides/ 관련 문서 (수동)"
    
    4_update_todo:
      action: "다음 세션 작업 리스트 업데이트"
      location: "세션 서머리 파일"

# ========================================
# STEP 4: umis_core.yaml 동기화 확인
# ========================================

umis_core_sync:
  purpose: "umis_core.yaml이 umis.yaml 변경사항 반영했는지 확인"
  file: "umis_core.yaml"
  
  check_items:
    version:
      umis_yaml: "version: 7.11.1"
      umis_core_yaml: "version: 7.11.1"
      must_match: true
    
    tool_count:
      current: "15 tools (v7.11.0)"
      after_onboarding: "19 tools (v7.11.1)"
      verify: "total_tools: 19"
    
    tool_list:
      check: "tools: 섹션"
      verify_exists:
        - "tier_0_onboarding (4개, 신규)"
        - "tier_1_system (9개)"
        - "tier_2_complete (6개)"
    
    ai_guide:
      check: "ai_guide: 섹션"
      verify: "Onboarding 로드 경로 포함"
  
  update_if_needed:
    command: "수동 편집 필요"
    note: "umis_core.yaml은 수동 관리 파일"

# ========================================
# STEP 5: System RAG 최신화
# ========================================

system_rag_update:
  purpose: "umis.yaml 변경사항을 System RAG에 반영"
  
  execution:
    step_1_sync:
      command: "python3 scripts/sync_umis_to_rag.py"
      action: "umis.yaml → tool_registry.yaml 동기화"
      output: "19개 도구 생성 (Onboarding 4 + System 9 + Complete 6)"
      backup: "config/backups/ 자동 생성"
    
    step_2_rebuild:
      command: "python3 scripts/build_system_knowledge.py"
      action: "ChromaDB 재구축"
      duration: "30초-1분"
    
    step_3_verify:
      command: "python3 scripts/query_system_rag.py --list"
      expected: "19개 도구 목록"
      verify:
        - "tool:onboarding:* (4개)"
        - "tool:system:* (9개)"
        - "tool:{agent}:complete (6개)"
    
    step_4_test:
      command: "python3 scripts/query_system_rag.py tool:onboarding:quick_start"
      expected: "정상 출력 (56줄)"
  
  combined_command: "/umis rebuild (자동 실행)"

# ========================================
# STEP 6: CHANGELOG & README 업데이트
# ========================================

documentation_update:
  
  changelog:
    file: "CHANGELOG.md"
    purpose: "기술적 변경 이력 (개발자용)"
    
    structure:
      format: "## [v7.11.1] - 2025-11-27"
      sections:
        added:
          - "신규 기능/파일/도구"
          - "예: Added ai_onboarding section to umis.yaml"
        
        changed:
          - "기존 기능 수정"
          - "예: Optimized .cursorrules from 360 to 74 lines"
        
        fixed:
          - "버그 수정"
          - "예: Fixed System RAG tool count validation"
        
        deprecated:
          - "더 이상 사용 안 함 (곧 제거)"
        
        removed:
          - "제거된 기능"
    
    style:
      - "기술적 상세 포함 (개발자가 이해 가능)"
      - "파일명, 라인 수, 함수명 등 구체적"
      - "Before/After 비교 포함"
  
  readme:
    file: "README.md"
    purpose: "프로젝트 소개 (첫 방문자용)"
    
    update_areas:
      top_section:
        when: "메이저 기능 추가"
        example: "6-Agent → 7-Agent"
        location: "상단 소개"
      
      features_list:
        when: "핵심 기능 추가"
        example: "AI Onboarding System"
        location: "Features 섹션"
      
      bottom_summary:
        when: "모든 업데이트"
        location: "문서 하단 Update Summary"
        format: |
          ## Recent Updates
          
          ### 2025-11-27 - v7.11.1
          - Optimized .cursorrules (360→74 lines, 80% reduction)
          - Added AI Onboarding system (4 new tools)
          - Introduced /umis system commands
          - Created UMIS_AI_REFERENCE.json (35% smaller than YAML)
    
    style:
      - "간결하고 명확 (비기술적)"
      - "주요 변경사항만 (세부사항 제외)"
      - "사용자 관점 (왜 중요한지)"

# ========================================
# ADDITIONAL CHECKS (추가 체크 항목)
# ========================================

additional_checks:
  
  git_status:
    purpose: "커밋되지 않은 변경사항 확인"
    command: "git status"
    action: "변경된 파일 목록 확인 → 세션 서머리에 포함"
  
  linting:
    purpose: "YAML 문법 검증"
    files:
      - "umis.yaml"
      - "umis_core.yaml"
      - "config/tool_registry.yaml"
    command: "python3 scripts/validate_all_yaml.py"
    fix_if_errors: true
  
  test_execution:
    purpose: "주요 기능 테스트"
    when: "코드 변경 시"
    commands:
      - "python3 -m pytest tests/unit/ -v"
      - "python3 scripts/query_system_rag.py --list"
  
  backup_check:
    purpose: "중요 파일 백업 확인"
    files:
      - "config/backups/tool_registry_*.yaml (자동)"
      - "umis.yaml (수동 백업 권장)"
    command: "ls config/backups/ -lt | head -5"
  
  cross_reference_check:
    purpose: "문서 간 일관성 확인"
    checks:
      - ".cursorrules 버전 = umis.yaml 버전"
      - "umis_core.yaml 도구 수 = tool_registry.yaml 도구 수"
      - "UMIS_ARCHITECTURE_BLUEPRINT.md 버전 = system 버전"
      - "README.md 최신 업데이트 날짜 = 오늘"

# ========================================
# EXECUTION SEQUENCE (실행 순서)
# ========================================

execution_sequence:
  trigger: ["/umis close", "세션 종료", "세션 마무리"]
  
  step_by_step:
    
    step_0:
      name: "파일 정리 및 이동"
      duration: "2-3분"
      actions:
        - "루트 폴더 .md 파일 확인"
        - "file_organization.rules 적용"
        - "임시 파일 삭제"
        - "git add (이동된 파일)"
      output: "정리된 폴더 구조"
    
    step_1:
      name: "세션 서머리 작성"
      duration: "5-10분"
      actions:
        - "세션 내용 회고"
        - "YAML 포맷으로 작성"
        - "다음 세션 컨텍스트 정리"
        - "git add session_summary"
      output: "dev_docs/session_summaries/SESSION_SUMMARY_*.yaml"
    
    step_2:
      name: "아키텍처 문서 업데이트"
      duration: "3-5분"
      actions:
        - "UMIS_ARCHITECTURE_BLUEPRINT.md 읽기"
        - "변경 섹션 찾기"
        - "업데이트 적용"
        - "메타데이터 갱신 (commit hash, date)"
        - "git add UMIS_ARCHITECTURE_BLUEPRINT.md"
      output: "최신 상태 아키텍처 문서"
    
    step_3:
      name: "umis.yaml 업데이트 및 의존성 파악"
      duration: "5-10분"
      actions:
        - "변경된 섹션 수정"
        - "YAML 검증"
        - "의존성 체인 파악"
        - "영향받는 파일 목록 작성"
        - "git add umis.yaml"
      output: "의존성 매트릭스 + 업데이트 계획"
    
    step_4:
      name: "umis_core.yaml 동기화"
      duration: "2-3분"
      actions:
        - "버전 일치 확인"
        - "도구 수 일치 확인"
        - "필요 시 수동 업데이트"
        - "git add umis_core.yaml"
      output: "동기화된 INDEX"
    
    step_5:
      name: "System RAG 재구축"
      duration: "1-2분"
      actions:
        - "/umis rebuild 실행"
        - "19개 도구 확인"
        - "Onboarding 도구 테스트"
      output: "최신 System RAG"
    
    step_6:
      name: "CHANGELOG & README 업데이트"
      duration: "3-5분"
      actions:
        - "CHANGELOG.md 버전 추가"
        - "README.md 하단 요약 업데이트"
        - "git add CHANGELOG.md README.md"
      output: "업데이트된 문서"
    
    step_7_additional:
      name: "추가 검증"
      duration: "2-3분"
      actions:
        - "git status 확인"
        - "YAML 문법 검증"
        - "교차 참조 확인"
        - "백업 확인"
      output: "검증 완료"
    
    step_8_commit:
      name: "Git 커밋"
      duration: "1분"
      actions:
        - "git status 확인"
        - "git diff 검토"
        - "커밋 메시지 작성"
        - "git commit"
      output: "커밋 완료"
      
      commit_message_template: |
        {type}: {subject}
        
        {body}
        
        Changed files:
        - {file1}
        - {file2}
        
        Session: SESSION_SUMMARY_{date}_{time}_{keywords}.yaml
      
      commit_types:
        - "feat: 새 기능"
        - "refactor: 리팩토링"
        - "docs: 문서 업데이트"
        - "fix: 버그 수정"
        - "chore: 유지보수"

# ========================================
# CHECKLIST TEMPLATE
# ========================================

checklist_template:
  use: "AI가 실행 시 체크"
  
  items:
    - "[ ] Step 0: 파일 이동 (루트 정리)"
    - "[ ] Step 1: 세션 서머리 작성 (YAML)"
    - "[ ] Step 2: ARCHITECTURE_BLUEPRINT 업데이트 (메타데이터)"
    - "[ ] Step 3: umis.yaml 업데이트 (의존성 파악)"
    - "[ ] Step 4: umis_core.yaml 동기화"
    - "[ ] Step 5: System RAG 재구축 (/umis rebuild)"
    - "[ ] Step 6: CHANGELOG & README 업데이트"
    - "[ ] Step 7: git status 확인"
    - "[ ] Step 8: YAML 검증"
    - "[ ] Step 9: 교차 참조 확인"
    - "[ ] Step 10: git commit"

# ========================================
# EXAMPLE OUTPUT
# ========================================

example_session_summary:
  filename: "SESSION_SUMMARY_20251127_1430_cursorrules_optimization.yaml"
  content_preview: |
    metadata:
      session_date: "2025-11-27"
      session_time: "14:30-16:45"
      duration: "2h 15min"
      branch: "alpha"
      version_before: "v7.11.0"
      version_after: "v7.11.1"
      keywords: ["cursorrules", "optimization", "system_rag"]
    
    summary:
      objective: "Optimize .cursorrules for AI comprehension and add AI Onboarding system"
      
      achievements:
        - "Reduced .cursorrules from 360 to 74 lines (80% compression)"
        - "Added ai_onboarding section to umis.yaml (225 lines)"
        - "Created 4 new Onboarding tools in System RAG"
        - "Introduced /umis system commands"
        - "Created UMIS_AI_REFERENCE.json (35% smaller than YAML)"
      
      key_decisions:
        - decision: "Use /umis prefix for system commands"
          reason: "Avoid LLM injection confusion, explicit user consent"
        
        - decision: "Use Minified JSON for AI reference"
          reason: "35% smaller, 3.6x faster parsing than YAML"
        
        - decision: "Keep .cursorrules in YAML"
          reason: "Natural language instructions + comments + readability"
      
      technical_changes:
        umis_yaml:
          - "Line 38-262: Added ai_onboarding section (225 lines)"
          - "Total: 6,838 → 7,063 lines"
        
        sync_script:
          - "Line 105-228: Added _create_onboarding_tools() method"
          - "Line 111-113: Filter ai_onboarding from system sections"
          - "Line 346: Added onboarding:quick_start to required tools"
        
        cursorrules:
          - "Complete rewrite: 360 → 74 lines"
          - "Added system commands section"
          - "Added installation check"
          - "Removed verbose explanations"
        
        new_files:
          - "UMIS_AI_REFERENCE.json (4,896 bytes, minified)"
          - "CURSOR_SYSTEM_COMMANDS.md (guide)"
          - "CURSOR_AUTO_SETUP.md (deprecated by system commands)"
    
    context_for_next_session:
      remaining_tasks:
        priority_1:
          - task: "Test .cursorrules with fresh Cursor IDE instance"
            context: "Verify installation detection works"
            files: [".cursorrules", "setup/setup.py"]
        
        priority_2:
          - task: "Update UMIS_ARCHITECTURE_BLUEPRINT.md"
            context: "Add ai_onboarding section, update metadata"
            files: ["docs/architecture/UMIS_ARCHITECTURE_BLUEPRINT.md"]
        
        priority_3:
          - task: "Consider TOON format for future optimization"
            context: "30-60% token savings, but experimental"
            research: "https://abdulkadersafi.com/blog/toon-the-token-efficient-data-format"
      
      required_context:
        file_structure:
          - "ai_onboarding at Line 38-262 of umis.yaml"
          - "Onboarding tools in System RAG (4 tools)"
        
        commands:
          - "python3 scripts/sync_umis_to_rag.py"
          - "python3 scripts/query_system_rag.py tool:onboarding:quick_start"
        
        key_insights:
          - "Minified JSON is 3.6x faster than YAML for parsing"
          - "AI reads 100% of 72-line files but only ~60% of 360-line files"
          - "System commands (/umis) prevent LLM injection confusion"
      
      errors_encountered:
        - error: "None"
          resolution: "All operations successful"
      
      terminal_commands:
        - "python3 scripts/sync_umis_to_rag.py"
        - "python3 scripts/query_system_rag.py --list"
        - "ls data/chroma_db/system_knowledge/"
    
    dependencies:
      modified_files:
        - path: "umis.yaml"
          lines_changed: "+225"
          sections: ["ai_onboarding (new)"]
        
        - path: "scripts/sync_umis_to_rag.py"
          lines_changed: "+68"
          methods: ["_create_onboarding_tools()"]
        
        - path: ".cursorrules"
          lines_changed: "-286"
          approach: "complete rewrite"
        
        - path: "UMIS_AI_REFERENCE.json"
          lines_changed: "+2"
          type: "new file"
      
      dependency_chain:
        umis_yaml:
          affects:
            - "tool_registry.yaml (auto-generated)"
            - "System RAG ChromaDB (rebuild required)"
            - "umis_core.yaml (manual sync needed)"
            - ".cursorrules (reference update)"
        
        sync_script:
          affects:
            - "tool_registry.yaml generation"
            - "Onboarding tools creation"
      
      update_required:
        immediate:
          - "umis_core.yaml (add Onboarding tools to list)"
          - "UMIS_ARCHITECTURE_BLUEPRINT.md (add Onboarding section)"
        
        next_session:
          - "CHANGELOG.md (add v7.11.1 entry)"
          - "README.md (update summary)"
    
    next_steps:
      immediate:
        - "Update umis_core.yaml (add tier_0_onboarding)"
        - "Update UMIS_ARCHITECTURE_BLUEPRINT.md metadata"
        - "Test installation detection on fresh fork"
      
      short_term:
        - "Write user documentation for /umis commands"
        - "Add /umis commands to README.md"
        - "Create video demo for onboarding"
      
      long_term:
        - "Evaluate TOON format (30-60% token savings)"
        - "A/B test: 74-line vs 360-line .cursorrules"
        - "Measure actual AI comprehension rate"

# ========================================
# USER APPROVAL SECTION
# ========================================

user_approval_required:
  step_0_folder_rules:
    status: "draft"
    action: "Review file_organization.rules and approve/modify"
    
  step_3_dependency_scope:
    status: "needs confirmation"
    action: "Verify dependency_chain is complete"
  
  step_8_commit_message:
    status: "needs review"
    action: "Review commit message before executing"

# ========================================
# END
# ========================================
